@echo off
setlocal

REM We need a JVM
if not defined JAVA_HOME  (
  echo Error: JAVA_HOME is not defined.
  exit /b
)

if not defined JAVACMD (
  set JAVACMD=%JAVA_HOME\bin\java.exe
)

if not exist %JAVACMD (
  echo Error: JAVA_HOME is not defined correctly.
  echo Cannot execute %JAVACMD
  exit /b
)


##Find the shibboleth components
if [ ! -n "$SHIB_HOME" ] ; then
  echo "Error: SHIB_HOME is not defined."
  exit
fi

## Where log4j config file is
LOG_CONFIG=$SHIB_HOME/conf/log4j.properties

if [ ! \( -f "$SHIB_HOME/lib/shib-util.jar" -a -r "$SHIB_HOME/lib/shib-util.jar" \) ] ; then
  echo "Error: Cannot find the shibboleth jar (shib-util.jar)."
  echo "       If you downloaded the shibboleth source, you need to run \"ant build-util\""
  exit
fi


##Grab all the dependencies
if [ -n "$CLASSPATH" ] ; then
  SHIB_UTIL_CLASSPATH=$CLASSPATH
fi

DIRLIBS=${SHIB_HOME}/lib/*.jar
for i in ${DIRLIBS}
do
    # if the directory is empty, then it will return the input string
    # this is stupid, so case for it
    if [ "$i" != "${DIRLIBS}" ] ; then
      if [ -z "$SHIB_UTIL_CLASSPATH" ] ; then
        SHIB_UTIL_CLASSPATH=$i
      else
        SHIB_UTIL_CLASSPATH="$i":$SHIB_UTIL_CLASSPATH
      fi
    fi
done


##Here we go
$JAVACMD -Dlog4j.configuration="$LOG_CONFIG" -cp $SHIB_UTIL_CLASSPATH  edu.internet2.middleware.shibboleth.utils.ExtKeyTool "$@"
