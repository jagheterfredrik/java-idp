<!doctype HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>

<head>
<meta http-equiv="Content-Language" content="en-us">
<title>Shibboleth Origin Deployment Guide</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">

html
{	
background-color: #FFFFFF;
color: #000000;
margin: .5em;
}
a:visited
{
color: #999999;
}
a:link
{
color: #990000;
}
a:active
{
color: #440000;
}
a.fixedlink:visited
{
font-family: monospace;
font-size: 90%;
color: #121212;
text-decoration: none;
}
a.fixedlink:link
{
font-family: monospace;
font-size: 90%;
color: #121212;
text-decoration: none;
}
a.fixedlink:active
{
font-family: monospace;
font-size: 90%;
color: #121212;
text-decoration: none;
}
dl
{
border-width:2px; background-color: #DDDDDD;
background-image: url('none');
margin: 5px;
padding: 0px;
border-style: solid;
}
dt
{
background-color: #DDDDDD;
background-image: url('none');
margin: 1px;
padding: 1px
}
dd
{
background-color: #DDDDDD;
background-image: url('none');
margin: 0px;
padding: 1px
}
.attribute
{
font-size: 115%;
font-color: #000000;
text-align: left;
background-color: #DDDDDD;
border: 1px inset black;
background-image: url('none');
margin: 0px;
padding: 2px
}
.value
{
font-color: #000000;
text-align: left;
background-color: #EEEEEE;
background-image: url('none');
padding-top: 0em;
padding-bottom: 0.5em;
padding-right: 1em;
padding-left: 5em;
border-bottom-width: none;
border-top-width: none;
border-left-width: 1px;
border-right-width: 1px; border-left-style:solid; border-right-style:solid; border-top-style:solid; border-bottom-style:solid
}
.mandatory
{
font-color: #000000;
background-color: #FFCCFF;
}

.attributelong
{
font-size: 85%;
font-color: #000000;
text-align: left;
background-color: #DDDDDD;
border: 1px inset black;
background-image: url('none');
margin: 0px;
padding: 2px
}
.demo
{
background-color: #EEEEEE;
padding: 3px;
}
.fixedwidth
{
font-family: monospace;
font-size: 90%;
font-color: #121212;
}
.feature
{
color: #00FF00
}
 </style>
</head>

<body link="red" vlink="red" alink="black" bgcolor="white">

<center>
<h2>Shibboleth Origin Deployment Guide</h2>
</center>
<p>Shibboleth Origin Deployment Guide<br>
Shibboleth Version 1.2<br>
March 18, 2004<br>
</p>
<h3>This version of the deploy guide is for Shibboleth v1.2. For documentation 
related to prior versions of Shibboleth, please consult the appropriate branch 
in the Shibboleth CVS.</h3>
<h3>Federations have been abstracted out from the Shibboleth documentation. For 
further information on using Shibboleth in a federation, refer to the federation 
guide.</h3>

<p>Insert features here.</p>

<p>Before starting, please sign up for all applicable
<a href="http://shibboleth.internet2.edu/shib-misc.html#mailinglist">mailing 
lists</a>. Announcements pertinent to Shibboleth deployments and developments 
and resources for deployment assistance can be found here.</p>
<p>Please send any questions, concerns, or eventual confusion to
<a href="mailto:mace-shib-users@internet2.edu">mace-shib-users@internet2.edu</a>. 
This should include, but not be limited to, questions about the documentation, 
undocumented problems, installation or operational issues, and anything else 
that arises. Please ensure that you have the
<a href="http://shibboleth.internet2.edu/release/shib-download.html">appropriate 
.tarball</a> for your operating system.</p>
<p><br>
</p>
<hr>
<p><br>
<br>
</p>
<h3><a name="TOC"></a>Shibboleth Origin -- Table of Contents</h3>
<p><br>
</p>
<ol type="1">
    <li>
    <h4><a href="#1."><font color="black">Shibboleth Overview</font></a></h4>
    <ol type="a">
        <li><a href="#1.a."><font color="black">Origin</font></a></li>
        <li><a href="#1.b."><font color="black">Target</font></a></li>
        <li><a href="#1.c."><font color="black">WAYF</font></a></li>
        <li><a href="#1.d."><font color="black">Federations</font></a></li>
    </ol>
    </li>
    <li>
    <h4><a href="#2."><font color="black">Planning</font></a></h4>
    <ol type="a">
        <li><a href="#2.a."><font color="black">Requirements</font></a></li>
        <li><a href="#2.b."><font color="black">Join a Federation</font></a></li>
        <li><a href="#2.c."><font color="black">Security Considerations</font></a></li>
        <li><a href="#2.d."><font color="black">Server Certs</font></a></li>
        <li><a href="#2.e."><font color="black">Attribute Release Policies</font></a></li>
        <li><a href="#2.f."><font color="black">Designate Contacts</font></a></li>
        <li><a href="#2.g."><font color="black">Browser Requirements</font></a></li>
        <li><a href="#2.h."><font color="black">Clocks</font></a></li>
        <li><a href="#2.i."><font color="black">Other Considerations</font></a></li>
    </ol>
    </li>
    <li>
    <h4><a href="#3."><font color="black">Installation</font></a></h4>
    <ol type="a">
        <li><a href="#3.a."><font color="black">Software Requirements</font></a></li>
        <li><a href="#3.b."><font color="black">Deploy HS and AA</font></a></li>
    </ol>
    </li>
    <li>
    <h4><a href="#4."><font color="black">Getting Running</font></a></h4>
    <ol type="a">
        <li><a href="#4.a."><font color="black">Basic Configuration</font></a>
        <ol type="i">
            <li><a href="#4.a.i"><font color="black">Modifying the default 
            Attribute Resolver configuration</font></a></li>
        </ol>
        </li>
        <li><a href="#4.b."><font color="black">Key Generation and Certificate 
        Installation</font></a> </li>
        <li><a href="#4.c."><font color="black">Linking the Authentication 
        System to the HS</font></a>
        <ol type="i">
            <li><a href="#4.c.i."><font color="black">Enabling client 
            certificate authentication</font> <font color="#5555EE">(optional)</font></a></li>
        </ol>
        </li>
        <li><a href="#4.d."><font color="black">Establishing default ARP&#39;s for 
        the origin community</font></a></li>
    </ol>
    </li>
    <li>
    <h4><a href="#5."><font color="black">Advanced Configuration</font></a></h4>
    <ol type="a">
        <li><a href="#5.a."><font color="black"><span class="fixedwidth">
        origin.xml</span></font></a></li>
        <li><a href="#5.b."><font color="black">ARP Overview</font></a>
        <ol type="i">
            <li><a href="#5.b.i."><font color="black">ARP Processing</font></a></li>
            <li><a href="#5.b.ii."><font color="black">ARP Syntax</font></a></li>
        </ol>
        </li>
        <li><a href="#5.c."><font color="black">Sharing certificate/key pairs 
        between Apache and Java keystores</font> <font color="#5555EE">
        (optional)</font></a></li>
        <li><a href="#5.d."><font color="black">The Attribute Resolver</font></a>
        <ol type="i">
            <li><a href="#5.d.i."><font color="black"><span class="fixedwidth">
            resolvertest</span></font></a></li>
        </ol>
        </li>
        <li><a href="#5.e."><font color="black">Local Error Page</font></a></li>
        
        <li><a href="#5.f."><font color="black">Using a New Attribute</font></a></li>
        
    </ol>
    </li>
    <li>
    <h4><a href="#6."><font color="black">Troubleshooting</font></a></h4>
    <ol type="a">
        <li><a href="#6.a."><font color="black">Basic Testing</font></a></li>
        <li><a href="#6.b."><font color="black">Logging</font></a></li>
        <li><a href="#6.c."><font color="black">Common Problems</font></a></li>
    </ol>
    </li>
</ol>
<p><br>
</p>
<hr>
<p><br>
</p>
<h3><a name="1."></a>1. Shibboleth Overview</h3>
<p>Shibboleth is a system designed to exchange attributes across realms for the 
primary purpose of authorization. It provides a secure framework for one 
organization to transmit attributes about a web-browsing individual across 
security domains to another institution. In the primary usage case, when a user 
attempts to access a resource at a remote domain, the user&#39;s own home security 
domain can send certain information about that user to the target site in a 
trusted exchange. These attributes can then be used by the resource to help 
determine whether to grant the user access to the resource. The user may have 
the ability to decide whether to release specific attributes to certain sites by 
specifying personal Attribute Release Policies (ARP&#39;s), effectively preserving 
privacy while still granting access based on trusted information.</p>
<p>When a user first tries to access a resource protected by Shibboleth, they 
are redirected to a service which asks the user to specify the organization from 
which they want to authenticate. If the user has not yet locally authenticated 
to a WebISO service, the user will then be redirected to their home 
institution&#39;s authentication system. After the user authenticates, the 
Shibboleth components at the local institution will generate a temporary 
reference to the user, known as a handle, for the individual and send this to 
the target site. The target site can then use the handle to ask for attributes 
about this individual. Based on these attributes, the target can decide whether 
or not to grant access to the resource. The user may then be allowed to access 
the requested materials.</p>
<p>There are several controls on privacy in Shibboleth, and mechanisms are 
provided to allow users to determine exactly which information about them is 
released. A user&#39;s actual identity isn&#39;t necessary for many access control 
decisions, so privacy often is needlessly compromised. Instead, the resource 
often utilizes other attributes such as faculty member or member of a certain 
class. While these are commonly determined using the identity of the user, 
Shibboleth provides a way to mutually refer to the same principal without 
revealing that principal&#39;s identity. Because the user is initially known to the 
target site only by a randomly generated temporary handle, if sufficient, the 
target site might know no more about the user than that the user is a member of 
the origin organization. This handle should never be used to decide whether or 
not to grant access, and is intended only as a temporary reference for 
requesting attributes.</p>
<h4><a name="1.a."></a>1.a. Origin</h4>
<blockquote>
    <p>There are four primary components to the origin side in Shibboleth: the 
    Attribute Authority (AA), the Handle Service (HS), the directory service, 
    and the local sign-on system (SSO). The AA and HS are provided with 
    Shibboleth, and an open-source WebISO solution, Pubcookie, can be obtained 
    from www.pubcookie.org; the directory is provided by the origin site. 
    Shibboleth is able to interface with a directory exporting an LDAP interface 
    containing user attributes, and is designed such that programming interfaces 
    to other repositories should be readily implemented. Shibboleth relies on 
    standard web server mechanisms to trigger local authentication. A .htaccess 
    file can be easily used to trigger either the local WebISO system or the web 
    server&#39;s own Basic Auth mechanism, which will likely utilize an enterprise 
    authentication system, such as Kerberos.</p>
    <p>From the origin site&#39;s point of view, the first contact will be the 
    redirection of a user to the handle service, which will then consult the SSO 
    system to determine whether the user has already been authenticated. If not, 
    then the browser user will be asked to authenticate, and then sent back to 
    the target URL with a handle bundled in an attribute assertion. Next, a 
    request from the Shibboleth Attribute Requester (SHAR) will arrive at the AA 
    which will include the previously mentioned handle. The AA then consults the 
    ARP&#39;s for the directory entry corresponding to the handle, queries the 
    directory for these attributes, and releases to the SHAR all attributes the 
    SHAR is entitled to know about that user.</p>
</blockquote>
<h4><a name="1.b."></a>1.b. Target</h4>
<blockquote>
    <p>There are three primary components to the target side in Shibboleth: the 
    Shibboleth Indexical Reference Establisher (SHIRE), the Shibboleth Attribute 
    Requester (SHAR), and the resource manager (RM). An implementation of each 
    of these is included in the standard Shibboleth distribution. These 
    components are intended to run on the same web server.</p>
    <p>From the target&#39;s point of view, a browser will hit the RM with a request 
    for a Shibboleth-protected resource. The RM then allows the SHIRE to step 
    in, which will use the WAYF to acquire the name of a handle service to ask 
    about the user. The handle service (HS) will then reply with a SAML 
    authentication assertion containing a handle, which the SHIRE then hands off 
    to the SHAR. The SHAR uses the handle and the supplied address of the 
    corresponding attribute authority (AA) to request all attributes it is 
    allowed to know about the handle. The SHAR performs some basic validation 
    and analysis based on attribute acceptance policies (AAP&#39;s). These 
    attributes are then handed off to the RM, which is responsible for using 
    these attributes to decide whether to grant access.</p>
</blockquote>
<h4><a name="1.c."></a>1.c. Where are you from? (WAYF)</h4>
<blockquote>
    <p>The WAYF service can be either outsourced and operated by a federation or 
    deployed as part of the SHIRE. It is responsible for allowing a user to 
    associate themself with an institution of their specification, then 
    redirecting the user to the known address for the handle service of that 
    institution.</p>
</blockquote>
<h4><a name="1.d."></a>1.d. Federations</h4>
<blockquote>
    <p>A Shibboleth federation provides part of the underlying trust required 
    for function of the Shibboleth architecture. A federation is a group of 
    organizations(universities, corporations, content providers, etc.) who agree 
    to exchange attributes using the SAML/Shibboleth protocols and abide by a 
    common set of policies and practices. In so doing, they must implicitly or 
    explicitly agree to a common set of guidelines. Joining a federation is not 
    explicitly necessary for operation of Shibboleth, but it dramatically 
    expands the number of targets and origins that can interact without defining 
    bilateral agreements between all these parties.</p>
    <p>A federation can be created in a variety of formats and trust models, but 
    must provide a certain set of services to federation members. It needs to 
    supply a registry to process applications to the federation and distribute 
    membership information to the origin and target sites. This must include 
    distribution of the PKI components necessary for trust between origins and 
    targets. There also needs to be a set of agreements and best practices 
    defined by the federation governing the exchange, use, and population of 
    attributes before and after transit, and there should be a way to find 
    information on local authentication and authorization practices for 
    federation members.</p>
</blockquote>
<p><br>
<br>
<br>
</p>
<hr>
<p><br>
</p>
<h3><a name="2."></a>2. Planning</h3>
<p>There are several essential elements that must be present in the environment 
to ensure Shibboleth functions well, both political and technical. Shibboleth is 
entirely written in Java on the origin side. These are the recommendations and 
requirements for a successful implementation of a Shibboleth origin.</p>
<h4><a name="2.a."></a>2.a. Requirements</h4>
<ul>
    <li>A common institutional directory service should be operational; 
    Shibboleth comes with LDAP capabilities built in, and the Attribute 
    Authority has a Java API which will allow specification of interfaces with 
    legacy directories. This is discussed further in <a href="#4.d.">section 4.d</a>.</li>
    <li>A method to authenticate browser users must be in place, preferably in 
    the form of an enterprise authentication service. Some form of an SSO or a 
    WebISO service is not explicitly necessary for Shibboleth; however, it is 
    highly recommended. Implementation details of this are discussed in
    <a href="#4.c.">section 4.c</a>.</li>
    <li>Shibboleth is known to work on Linux and Solaris, but should function on 
    any platform that has a Tomcat implementation.</li>
    <li>It is recommended that a web server must be deployed that can host Java 
    servlets and Tomcat, although not explicitly necessary, as Tomcat can still 
    host an origin without it.</li>
</ul>
<h4><a name="2.b."></a>2.b. Join a Federation</h4>
<blockquote>
    <p>While it is not necessary for a target or origin to join a federation, 
    doing so greatly facilitates the implementation of multilateral trust 
    relationships. Each federation will have a different application process. 
    When an origin is accepted into a federation, its information is added to 
    the sites file used by the WAYF and target sites.</p>
    <p><b>It may be necessary to join multiple federations depending on the 
    sites with whom you wish to exchange attributes and the terms under which 
    these interactions will take place. An origin site exists within the context 
    of a single federation, while a single target may accept assertions issued 
    by multiple federations if they are all recognized by the SHAR. If an 
    organization wishes to be a member of multiple federations, it must run a 
    separate origin site for each federation, including a separate AA and HS.</b></p>
    <p>Attribute release and acceptance policies, the use and caching of 
    attributes, and definition of commonly traded attributes are examples of 
    specifications a federation may make. For more information on federations, 
    please refer to the Deployer&#39;s Guide to Federations and the Shibboleth v1.0 
    architectural document.</p>
</blockquote>
<h4><a name="2.c."></a>2.c. Security Considerations</h4>
<blockquote>
    <p>Shibboleth&#39;s protocols and software have been extensively engineered to 
    provide protection against many attacks. However, the most secure protocol 
    can be compromised if it is placed in an insecure environment. To ensure 
    Shibboleth is as secure as possible, there are several recommended security 
    precautions which should be in place at local sites.</p>
    <ol type="i">
        <li>SSL use is optional for origin sites. Federation guidelines should 
        be considered when determining whether to implement SSL, and, in 
        general, SSL should be used for interactions with client machines to 
        provide the necessary authentication and encryption to ensure protection 
        from man-in-the-middle attacks. It is strongly suggested that all 
        password traffic or similarly sensitive data should be SSL-protected. 
        Assessment of the risk tradeoff against possible performance degradation 
        should be performed for all applications.</li>
        <li>Many other attacks can be made on the several redirection steps that 
        Shibboleth takes to complete attribute transfer. The best protection 
        against this is safeguarding the WAYF service and ensuring that rogue 
        targets and origins are not used, generally by development of the trust 
        model underneath Shibboleth. Shibboleth also leverages DNS for security, 
        which is not uncommon, but attacks concerning bad domain information 
        should be considered.</li>
        <li>Information regarding origin users is generally provided by the 
        authoritative enterprise directory, and the acceptance of requests from 
        target applications can be carefully restricted to ensure that all 
        requests the SHAR performs are authorized and all information the origin 
        provides is accurate. Proper security measures should also be in place 
        on directory access and population(see
        <a href="http://www.georgetown.edu/giia/internet2/ldap-recipe/#AccessControl">
        Access Control</a> in the
        <a href="http://www.georgetown.edu/giia/internet2/ldap-recipe/">LDAP 
        recipe</a> for more information). Use of plaintext passwords is strongly 
        advised against.</li>
        <li>Server platforms should be properly secured, commensurate with the 
        level that would be expected for a campus&#39; other security services, and 
        cookie stores on client machines should be well protected.</li>
    </ol>
</blockquote>
<h4><a name="2.d."></a>2.d. Server Certs</h4>
<blockquote>
    <p>In the Shibboleth architecture, the SHIRE, SHAR, HS, and AA must all have 
    various client and/or server certificates for use in signing assertions and 
    creating SSL channels. These should be issued by a commonly accepted CA, 
    which may be stipulated by some Federation rules. Different federations may 
    require the use of different CA&#39;s.</p>
</blockquote>
<h4><a name="2.e."></a>2.e. Attribute Release Policies</h4>
<blockquote>
    <p>The Attribute Authority maintains a set of policies called Attribute 
    Release Policies (or ARP&#39;s) that govern the sharing of user attributes with 
    Shibboleth target sites. When a user attempts to access a 
    Shibboleth-protected resource, that resource&#39;s SHAR queries the user&#39;s AA 
    for all attributes to which it is entitled. The SHAR provides its own name 
    and the URL of the resource on behalf of which it is making the request. The 
    AA finds the attributes associated with the browser user, determines an 
    &quot;Effective ARP&quot; for this user, and then sends to the SHAR only the 
    attributes/values allowed in this policy.</p>
    <p>An ARP may be thought of as a sort of filter for outbound attributes; it 
    cannot create attributes or data that aren&#39;t originally present, but it can 
    limit the attributes released and the values those attributes may have when 
    released. It does not change the information in the data sources in any way.</p>
    <p>Each ARP is comprised of one or more rules that specify which attributes 
    and values may be released to a target or set of targets. The assignment of 
    rules to various targets is quite flexible and includes mechanisms for 
    specifying: that a rule should affect all targets (default rule), exact SHAR 
    names for which a rule is applicable, regular expressions against which SHAR 
    names should be matched to determine if a rule is applicable, URL trees for 
    which a rule is applicable.</p>
    <p>For each request, an Effective ARP is determined by locating all ARP&#39;s 
    applicable to the designated user and extracting each rule that matches the 
    querying SHAR and resource. Attributes and values that are specified for 
    release are included in the effective ARP, while those specified for denial 
    are blocked from release. See section <a href="#5.b.i.">5.b.i</a> for 
    details on how ARP&#39;s are processed.</p>
    <p>Various ARP&#39;s may be combined in forming the Effective ARP. For instance, 
    the Site ARP is administratively maintained and applies to all users for 
    which the AA is answerable. User ARP&#39;s apply to a specific user only, and 
    can be maintained either administratively or by the users themselves. All 
    ARP&#39;s are specified using the same syntax and semantics.</p>
</blockquote>
<h4><a name="2.f."></a>2.f. Designate Contacts</h4>
<blockquote>
    <p>Since Shibboleth deals both with daily technical and operational issues 
    and also with contractual issues, a set of contacts should be set up to 
    support the user base and to facilitate interactions with other Shibboleth 
    sites and federation members. It is recommended that at least technical and 
    administrative contacts be designated.</p>
</blockquote>
<h4><a name="2.g."></a>2.g. Browser Requirements</h4>
<blockquote>
    <p>A primary Shibboleth design consideration was to require very little or 
    no modification to client machines. The only requirement is that a browser 
    is used which supports cookies, redirection and SSL. Browser users will have 
    to perform an additional click to submit the authentication assertion if 
    JavaScript is not functional.</p>
</blockquote>
<h4><a name="2.h."></a>2.h. Clocks</h4>
<blockquote>
    <p><a href="http://www.eecis.udel.edu/~ntp/">NTP</a> should be run on all 
    web servers. Shibboleth employs a short handle issuance time to protect 
    against replay attacks. Because of this, any significant degree of clock 
    skew can hinder the ability of users to access sites successfully.</p>
</blockquote>
<h4><a name="2.i."></a>2.i. Other Considerations</h4>
<blockquote>
    <p>Especially for higher education, there are a handful of laws enacted 
    which may have important ramifications on the disclosure of personal 
    information and attributes. Since Shibboleth does not necessarily need to 
    transmit identity, it is an ideal solution for many higher education 
    situations. Nevertheless, all parties within the United States of America 
    are strongly advised to consult the
    <a href="http://www.ed.gov/offices/OM/fpco/ferpa/">Family Educational Rights 
    and Privacy Act of 1974(FERPA)</a>, and all other relevant state and federal 
    legislation before deploying Shibboleth.</p>
</blockquote>
<p><br>
<br>
</p>
<hr>
<p><br>
</p>
<h3><a name="3."></a>3. Installation</h3>
<h4><a name="3.a."></a>3.a. Software Requirements</h4>
<p><b>The following requirements are primarily recommendations based on the most 
common ways to run Shibboleth. However, the origin should be able to run under 
any servlet container supporting <span class="fixedwidth">Servlet API v2.3</span> 
and <span class="fixedwidth">JSP specification 1.2</span>.</b></p>
<blockquote>
    <ul type="circle">
        <li><a href="http://http://www.apache.org/dist/httpd/">Apache 1.3.26+ 
        (&lt;2.0)</a></li>
        <li><a href="http://jakarta.apache.org/tomcat/">Tomcat 4.1.18-24 LE Java 
        server</a></li>
        <li><a href="http://java.sun.com/j2se/">Sun J2SE JDK v1.4.1_01 and above</a>
        <blockquote>
            <p>Other versions of the JRE are not supported and are known to 
            cause errors when working with certificates.</p>
        </blockquote>
        </li>
        <li>mod_jk
        <blockquote>
            <p>You may need to build mod_jk against Apache, which will generally 
            require GCC or a platform-specific C compiler.</p>
        </blockquote>
        </li>
        <li>An enterprise authentication mechanism
        <blockquote>
            <p>Ideally, this will be a WebISO or SSO system such as
            <a href="http://pubcookie.org/">Pubcookie</a>. The minimal 
            requirement is for the web server to be able to authenticate browser 
            users and supply their identity to the Handle Server.</p>
        </blockquote>
        </li>
        <li>An enterprise directory service
        <blockquote>
            <p>Shibboleth currently supports retrieving user attribute 
            information from an <a href="http://www.openldap.org">LDAP</a> 
            directory. For testing purposes, Shibboleth also supports a minimal 
            echo responder which will always return pre-defined attributes.</p>
        </blockquote>
        </li>
    </ul>
</blockquote>
<h4><a name="3.b."></a>3.b. Deploy HS and AA</h4>
<blockquote>
    <ol type="1">
        <li>Ensure you have already obtained the proper
        <a href="http://shibboleth.internet2.edu/release/shib-download.html">.tarball</a>.</li>
        <li>The archive will expand into a <span class="fixedwidth">
        shibboleth-origin-1.1/</span> directory(<span class="fixedwidth">/opt/</span> 
        recommended).</li>
        <li>Run the following command to move the Java files into Tomcat&#39;s tree:<blockquote>
            <p><span class="fixedwidth">cp /opt/shibboleth-origin-1.1/dist/shibboleth.war 
            /usr/local/tomcat/webapps/</span> </p>
        </blockquote>
        </li>
        <li>Tomcat 4.1.x requires that several Java jarfiles used by Shibboleth 
        be located in a special &quot;endorsed&quot; folder to override obsolete classes 
        that Sun includes with their JVM. To deal with this problem use the 
        following command, adjusting paths as needed:<blockquote>
            <p><span class="fixedwidth">$ cp 
            /opt/shibboleth-origin-1.1/endorsed/*.jar /usr/local/tomcat/common/endorsed</span>
            </p>
        </blockquote>
        <p>Different versions of Tomcat or other Java servers may have other 
        locations in which to place these files or deal with this problem. Refer 
        to your application server&#39;s documentation to find out how to properly 
        endorse classes, if necessary.</li>
        <li>Restart Tomcat, which will automatically detect that there has been 
        a new .war file added. This file will by default be expanded into
        <span class="fixedwidth">/usr/local/tomcat/webapps/shibboleth</span>.</li>
        <li>Apache must be told to map the URL&#39;s for the Shibboleth HS and AA to 
        Tomcat. Two popular ways of doing this are to include the following text 
        directly in <span class="fixedwidth">httpd.conf</span>, or to place
        <span class="fixedwidth">Include conf/mod_jk.conf</span> in
        <span class="fixedwidth">httpd.conf</span>, and place the following 
        lines in <span class="fixedwidth">/etc/httpd/conf/mod_jk.conf</span>:<blockquote>
            <p><span class="fixedwidth">--------- begin ---------<br>
            &lt;IfModule !mod_jk.c&gt;<br>
            &nbsp;LoadModule jk_module libexec/mod_jk.so<br>
            &lt;/IfModule&gt;<br>
            <br>
            JkWorkersFile &quot;/usr/local/tomcat/conf/jk/workers.properties&quot;<br>
            JkLogFile &quot;/usr/local/apache/logs/mod_jk.log&quot;<br>
            <br>
            JkLogLevel emerg<br>
            <br>
            JkMount /shibboleth/* ajp13<br>
            <br>
            --------- end ---------</span> </p>
        </blockquote>
        </li>
        <li>Tomcat&#39;s <span class="fixedwidth">/conf/server.xml</span> ships by 
        default with the Coyote/JK2 connector enabled, which fails with 
        Shibboleth due to the lack of support for <span class="fixedwidth">
        REMOTE_USER</span>. This connector must be commented out. Then, 
        uncomment and modify the traditional AJP 1.3 connector as follows:<ol type="A">
            <li>Add <span class="fixedwidth">address=&quot;127.0.0.1&quot;</span> inside 
            the <span class="fixedwidth">&lt;Ajp13Connector&gt;</span> configuration 
            element to prevent off-host access.</li>
            <li>Add <span class="fixedwidth">tomcatAuthentication=&quot;false&quot;</span> 
            to the <span class="fixedwidth">&lt;Ajp13Connector&gt;</span> 
            configuration element to ensure that the user&#39;s identity is passed 
            from Apache to the servlet environment.</li>
            <li>The AJP13Connector for tomcat is not compatible with the new JMX support.  To remove some warnings that will  appear in the tomcat log every time tomcat is restarted, comment out all of the JMX stuff (anything that says "mbeans") from server.xml.</li>
        </ol>
        </li>
        <li>It is <b>strongly</b> recommended that the AA be SSL-protected to 
        protect attributes in transit. To do so, add an appropriate location 
        block to <span class="fixedwidth">httpd.conf</span>:<blockquote>
            <p><span class="fixedwidth">&lt;Location /shibboleth/AA&gt; 
            <br>&nbsp;SSLVerifyClient optional 
            <br>&nbsp;SSLOptions +StdEnvVars +ExportCertData 
			<br>&lt;/Location&gt; </span></p>
        </blockquote>
        </li>
    </ol>
</blockquote>
<p><br>
</p>
<hr>
<p><br>
</p>
<h3><a name="4."></a>4. Getting Running</h3>
<h4><a name="4.a."></a>4.a. Basic Configuration</h4>
<blockquote>
    <p><b>This section of the deploy guide describes only the default <span
    class="fixedwidth">origin.xml</span> file and enumerates the essential
    changes that need to be made to the configuration defaults for the origin to
    function successfully in a federated environment. More complex configuration
    will likely be required for many applications and federations; for a fully
    defined example <span class="fixedwidth">origin.xml</span> and definition of
    every element and attribute that may be used, please refer to <a
    href="#5.a.">section 5.a</a>.</b></p>
    <p>The main configuration file for Shibboleth&#39;s origin side is located in
    <span class="fixedwidth">/webapps/shibboleth/WEB-INF/classes/conf/origin.xml</span>.
    The configuration must be consistent with values elsewhere in the 
    deployment, such as the <a href="#4.c.">HS&#39; certificate</a> and with 
    directory access bindings, etc., or access errors may occur.</p>
    <p>All pathnames are relative, and have an effective root path of
    <span class="fixedwidth">$TOMCAT_HOME/webapps/shibboleth/WEB-INF/classes/</span>. 
    To specify files outside of the webapp, specify a full URI, such as
    <span class="fixedwidth">file:///usr/local/shibboleth/</span>.</p>
    <p>The following is a hyperlinked version of the basic configuration file, followed by a list of elements and attributes that must be modified.  Click on any attribute or element for more information on its population and definition.</p>

<blockquote><span class="fixedwidth">
&lt;?xml version=&quot;1.0&quot;encoding=&quot;UTF-8&quot;?&gt;<br>
<br>
<a href="#confShibbolethOriginConfig" class="fixedlink">&lt;ShibbolethOriginConfig <br>
&nbsp;&nbsp;&nbsp;xmlns=&quot;urn:mace:shibboleth:origin:1.0&quot;<br>
&nbsp;&nbsp;&nbsp;xmlns:cred=&quot;urn:mace:shibboleth:credentials:1.0&quot;<br>
&nbsp;&nbsp;&nbsp;xmlns:name=&quot;urn:mace:shibboleth:namemapper:1.0&quot;<br>
&nbsp;&nbsp;&nbsp;xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;<br>
&nbsp;&nbsp;&nbsp;xsi:schemaLocation=&quot;urn:mace:shibboleth:origin:1.0 origin.xsd&quot;<br>
&nbsp;&nbsp;&nbsp;AAUrl=&quot;http://therock.cc.columbia.edu:6666/shibboleth/AA&quot;<br>
&nbsp;&nbsp;&nbsp;defaultRelyingParty=&quot;urn:mace:inqueue&quot;<br>
&nbsp;&nbsp;&nbsp;providerId=&quot;urn:mace:inqueue:shibdev.edu&quot;&gt;</a><br>
<br>
<a href="#confRelyingParty" class="fixedlink">&nbsp;&nbsp;&nbsp;&lt;RelyingParty name=&quot;urn:mace:inqueue&quot; signingCredential=&quot;foo&quot;&gt;<br></a>
<a href="#confHSNameFormat" class="fixedlink">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;HSNameFormat nameMapping=&quot;crypto&quot;/&gt;</a><br>
<a href="#confRelyingParty" class="fixedlink">&nbsp;&nbsp;&nbsp;&lt;/RelyingParty&gt;</a><br>
<br>
<a href="#confReleasePolicyEngine" class="fixedlink">&nbsp;&nbsp;&nbsp;&lt;ReleasePolicyEngine&gt;<br></a>
<a href="#confArpRepository" class="fixedlink">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;ArpRepository implementation=&quot;edu.internet2.middleware.shibboleth.aa.arp.provider.FileSystemArpRepository&quot;&gt;</a><br>
<a href="#confPath" class="fixedlink">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;Path&gt;/conf/arps/&lt;/Path&gt;</a><br>
<a href="#confArpRepository" class="fixedlink">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/ArpRepository&gt;</a><br>
<a href="#confReleasePolicyEngine" class="fixedlink">&nbsp;&nbsp;&nbsp;&lt;/ReleasePolicyEngine&gt;</a><br>
<br>
&nbsp;&nbsp;&nbsp;&lt;!--<br>
<a href="#confLogging" class="fixedlink">&nbsp;&nbsp;&nbsp;&lt;Logging&gt;</a><br>
<a href="#confLog4JConfig" class="fixedlink">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;Log4JConfig location=&quot;file:///tmp/log4j.properties&quot;/&gt;</a><br>
<a href="#confLogging" class="fixedlink">&nbsp;&nbsp;&nbsp;&lt;/Logging&gt;</a><br>
<a href="#confLogging" class="fixedlink">&nbsp;&nbsp;&nbsp;&lt;Logging&gt;</a><br>
<a href="#confErrorLog" class="fixedlink">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;ErrorLog level=&quot;DEBUG&quot; location=&quot;file:///tmp/shib-error.log&quot;/&gt;</a><br>
<a href="#confTransactionLog" class="fixedlink">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;TransactionLog location=&quot;file:///tmp/shib-access.log&quot;/&gt;</a><br>
<a href="#confLogging" class="fixedlink">&nbsp;&nbsp;&nbsp;&lt;/Logging&gt;</a><br>
&nbsp;&nbsp;&nbsp;--&gt;<br>
<br>
<a href="#confNameMapping" class="fixedlink">&nbsp;&nbsp;&nbsp;&lt;NameMapping <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xmlns=&quot;urn:mace:shibboleth:namemapper:1.0&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;id=&quot;crypto&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;format=&quot;urn:mace:shibboleth:1.0:nameIdentifier&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type=&quot;SharedMemoryShibHandle&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;handleTTL=&quot;1800&quot;/&gt;</a><br>
<br>
<a href="#confCredentials" class="fixedlink">&nbsp;&nbsp;&nbsp;&lt;Credentials xmlns=&quot;urn:mace:shibboleth:credentials:1.0&quot;&gt;</a><br>
<a href="#confFileResolver" class="fixedlink">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;FileResolver Id=&quot;foo&quot;&gt;</a><br>
<a href="#confKey" class="fixedlink">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;Key format=&quot;DER&quot;&gt;</a><br>
<a href="#confPath" class="fixedlink">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;Path&gt;/conf/shib2.key&lt;/Path&gt;</a><br>
<a href="#confKey" class="fixedlink">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/Key&gt;</a><br>
<a href="#confCertificate" class="fixedlink">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;Certificate format=&quot;PEM&quot;&gt;</a><br>
<a href="#confPath" class="fixedlink">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;Path&gt;/conf/shib2.crt&lt;/Path&gt;</a><br>
<a href="#confCertificate" class="fixedlink">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/Certificate&gt;</a><br>
<a href="#confFileResolver" class="fixedlink">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/FileResolver&gt;</a><br>
<a href="#confCredentials" class="fixedlink">&nbsp;&nbsp;&nbsp;&lt;/Credentials&gt;</a><br>
<br>
<a href="#confShibbolethOriginConfig" class="fixedlink">&lt;/ShibbolethOriginConfig&gt;</a>
</span></blockquote>

<p>The following changes must be made to the default configuration before the origin will interoperate in a federation.</p>
    <ol type="1">
        <li> 
        <p>Attributes within the <a href="#confShibbolethOriginConfig"><span
        class="fixedwidth">ShibbolethOriginConfig</span></a> element:</p>
            <ol type="a">
            <li><a href="#confShibbolethOriginConfig"><span class="fixedwidth">AAUrl=<i>URL</i></span></a>
            <blockquote>
                <p>This will be the URL assigned the AA servlet in step
                <a href="#3.b.">3.b</a>. Note that this <b>must</b> be an
                <span class="fixedwidth">https://</span> URL in order for the AA to 
                know which SHAR is requesting attributes.</p>
            </blockquote>
            </li>
            <li><a href="#confShibbolethOriginConfig"><span class="fixedwidth">providerID=<i>URN</i></span></a>
            <blockquote>
                <p>This will be the URN assigned to this origin by the federation.</p>
            </blockquote>
            </li>
            <li><a href="#confShibbolethOriginConfig"><span class="fixedwidth">defaultRelyingParty=<i>URN</i></span></a>
            <blockquote>
                <p>This is the URN of the primary federation that the origin operates within.</p>
            </blockquote>
            </li>
            </ol>
        </li>
        <li> 
        <p>Although not explicitly necessary, it's highly recommended that logging be activated at the <span class="fixedwidth">DEBUG</span> level by uncommenting the second <a href="#confLogging"><span class="fixedwidth">Logging</span></a> element and ensuring that the pathnames for <a href="#confTransactionLog"><span class="fixedwidth">TransactionLog</span></a> and <a href="#confErrorLog"><span class="fixedwidth">ErrorLog</span></a> are appropriate.</p>
        </li>
        <li>
        <p>The default configuration file informs Shibboleth to load its key and certificate from flat files.  The <a href="#confKey"><span class="fixedwidth">Key</span></a> element specifies a key in <span class="fixedwidth">DER</span> format located at <span class="fixedwidth">/conf/shib2.key</span>, while the <a href="#confCertificate"><span class="fixedwidth">Certificate</span></a> element specifies the corresponding certificate in <span class="fixedwidth">PEM</span> format located at <span class="fixedwidth">/conf/shib2.crt</span>.  If any of these values is inconsistent with your deployment, change it accordingly.  Note that keys are supported in a variety of formats: DER, PEM, encrypted PEM, PKCS8, and encrypted PKCS8.  If a keystore must be used instead, consult <a href="#5.a.">section 5.a</a> for appropriate structure and details on population.</p>
        </li>
    </ol>
</blockquote>
<p><br>
</p>
<h4><a name="4.a.i"></a>4.a.i Modifying the default Attribute Resolver 
configuration</h4>
<blockquote>
    <p>The resolver.xml file controls the retrieval of attributes from 
    enterprise repositories, and the process of mapping them to Shibboleth/SAML 
    attributes. For more precise information regarding how attributes are 
    processed or syntactically formed, please refer to section <a href="#5.d.">
    5.d.</a></p>
    <p>In order to make the Shibboleth software operational, however, minor 
    edits must be made to the example version of the resolver.xml file. The file 
    can be found at <span class="fixedwidth">/webapps/shibboleth/WEB-INF/classes/conf/resolver.xml.</span> 
    Two changes are necessary:</p>
    <p>1. The value of the smartScope attribute should be changed to the Domain 
    Name value submitted to the Federation. It appears on two 
    SimpleAttributeDefinition elements: eduPersonScopedAffiliation and 
    eduPersonPrincipalName.</p>
    <p>2. The comment indicators should be removed from around the definitions 
    of those two elements ( &lt;!-- and --&gt; ).</p>
</blockquote>
<p><br>
</p>
<h4><a name="4.b."></a>4.b. Key Generation and Certificate Installation</h4>
<blockquote>
    <p>The SAML messages generated by the HS must be digitally signed. Each HS 
    must be issued a private and public keypair, which is stored in a Java 
    keystore. The current implementation of Shibboleth requires the use of an 
    ordinary file-based keystore. The keytool program is included with the Java 
    development and runtime kits. Access parameters to the keystore will need to 
    be consistent with those specified in <span class="fixedwidth">
    origin.properties</span>.</p>
    <p>A sample keystore is included in the distribution and can be found in
    <span class="fixedwidth">/usr/local/tomcat/webapps/shibboleth/WEB-INF/classes/conf/keystore 
    .jks</span> with a password of <span class="fixedwidth">shibhs</span>. It is 
    intended to serve as an example and not as a production keystore.</p>
    <p>The following commands will generate a new RSA keypair and store it in 
    the <span class="fixedwidth">keystore.jks</span> file, with a keyentry alias 
    of <span class="fixedwidth">hs</span> and new passwords of your choosing:</p>
    <blockquote>
        <p><span class="fixedwidth">$ cd /usr/local/tomcat/webapps/shibboleth/WEB-INF/classes/conf<br>
        $ keytool -storepasswd -keystore keystore.jks -new &lt;newpassword&gt;<br>
        $ keytool -genkey -keystore keystore.jks -alias hs -keyalg rsa -keysize 
        2048<br>
        </span></p>
    </blockquote>
    <p>You will be prompted for passwords during key generation as needed, to 
    access the keystore and assign the key itself its own password. You will 
    also be prompted for the distinguished name components to associate with the 
    key. This DN will be placed in a self-signed certificate and will be the 
    name that is associated with your HS by Shibboleth. In particular, the first 
    component you enter for Name will be the <span class="fixedwidth">Common 
    Name</span>(when keytool asks for first and last name, common name is 
    intended), which in most cases should be the hostname of the HS system. Note 
    that a specific federation of sites may dictate what type of key algorithm, 
    key size, or validity period is appropriate.</p>
    <p>Once you have a keypair generated, the self-signed certificate must be 
    replaced with a certificate signed by a CA acceptable to the federation you 
    will be joining. Shibboleth is generally able to climb trust chains to reach 
    an intermediate CA&#39;s root CA. Note that the intermediate CA&#39;s signing 
    certificate must still be signed by a root CA recognized by the federation.</p>
    <p>To generate a certificate signing request for a CA, use the following 
    command:</p>
    <blockquote>
        <p><span class="fixedwidth">$ keytool -certreq -keystore keystore.jks 
        -alias hs -file &lt;csr-file&gt;<br>
        </span></p>
    </blockquote>
    <p>The contents of <span class="fixedwidth">&lt;csr-file&gt;</span> can then be 
    sent to a CA for signing. You will receive a signed certificate in return in 
    a file. To install the new certificate into your keystore, use the following 
    command:</p>
    <blockquote>
        <p><span class="fixedwidth">$ keytool -import -keystore keystore.jks 
        -alias hs -file &lt;cert-file&gt;</span> </p>
    </blockquote>
    <p>Note that if the signing CA&#39;s certificate is not already installed in 
    your keystore as a trusted signer, you may need to download the CA&#39;s root 
    certificate and import it into the keystore file under a different alias, 
    using a command similar to the above.</p>
    <p>For information on sharing certificate/key pairs between Apache and Java 
    keystores see section <a href="#5.c.">5.c.</a>.</p>
</blockquote>
<h4><a name="4.c."></a>4.c. Linking the Authentication System to the HS</h4>
<blockquote>
    <p>The interaction between the HS and the local authentication system is 
    implemented by supplying the HS with the identity of the browser user. Most 
    often, this will mean protecting the HS servlet with some form of local 
    authentication that populates <span class="fixedwidth">REMOTE_USER</span>. 
    Location blocks can be added to <span class="fixedwidth">httpd.conf</span>, 
    associating the appropriate authentication mechanism with the URL of the HS 
    servlet. The following example demonstrates association of a very basic 
    authentication method with the HS:</p>
    <blockquote>
        <p><span class="fixedwidth">&lt;Location /shibboleth/HS&gt;<br>
        AuthType Basic<br>
        AuthName &quot;Internet2 Handle Service&quot;<br>
        AuthUserFile /usr/local/apache/conf/user.db<br>
        require valid-user<br>
        &lt;/Location&gt;<br>
        </span></p>
    </blockquote>
    <p>Note that .htaccess files cannot be used for this purpose because URL&#39;s 
    are &quot;virtualized&quot; by Tomcat.</p>
    <p>It is recommended that the origin be tested at the end of this process 
    using the process described in section <a href="#6.a.">6.a</a>.</p>
</blockquote>
<h4><a name="4.c.i."></a>4.c.i. Enabling client certificate authentication
<font color="#5555EE">(optional)</font></h4>
<blockquote>
    <blockquote>
        <p>Shibboleth supports client certificate authentication by utilization 
        of a filter that relies on the web server to do all processing to ensure 
        that the certificate is both valid and appropriate for the application. 
        An example deployment descriptor is included with the Shibboleth 
        distribution at <span class="fixedwidth">$SHIB_HOME/webAppConfig/origin-client-cert.xml</span>. 
        To enable the filter, add the following to the deployment descriptor (<span class="fixedwidth">web.xml</span>):</p>
        <blockquote>
            <p><span class="fixedwidth">&nbsp;&nbsp;&lt;filter&gt;<br>
            &nbsp;&nbsp;&nbsp;&nbsp;&lt;filter-name&gt;<br>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Client Cert AuthN Filter<br>
            &nbsp;&nbsp;&nbsp;&nbsp;&lt;/filter-name&gt;<br>
            &nbsp;&nbsp;&nbsp;&nbsp;&lt;filter-class&gt;<br>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edu.internet2.middleware.shibboleth.utils.ClientCertTrustFilter<br>
            &nbsp;&nbsp;&nbsp;&nbsp;&lt;/filter-class&gt;<br>
            &nbsp;&nbsp;&lt;/filter&gt;<br>
            <br>
            <br>
            &nbsp;&nbsp;&lt;filter-mapping&gt;<br>
            &nbsp;&nbsp;&nbsp;&nbsp;&lt;filter-name&gt;<br>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Client Cert AuthN Filter<br>
            &nbsp;&nbsp;&nbsp;&nbsp;&lt;/filter-name&gt;<br>
            &nbsp;&nbsp;&nbsp;&nbsp;&lt;url-pattern&gt;<br>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/HS<br>
            &nbsp;&nbsp;&nbsp;&nbsp;&lt;/url-pattern&gt;<br>
            &nbsp;&nbsp;&lt;/filter-mapping&gt;<br>
            </span></p>
        </blockquote>
        <p>By default, the filter pulls the principal name out of the
        <span class="fixedwidth">CN</span> of the cert&#39;s
        <span class="fixedwidth">Subject</span> by using regular expression 
        grouping. This may be done using patterns such as:</p>
        <blockquote>
            <p><span class="fixedwidth">regex: &#39;.*CN=([^,/]+).*&#39; match group: 1</span>
            </p>
        </blockquote>
        <p>The servlet filter will accept two initialization parameters,
        <span class="fixedwidth">regex</span> and <span class="fixedwidth">
        matchGroup</span> that can be used to extract the principal name 
        differently.</p>
    </blockquote>
</blockquote>
<h4><a name="4.d."></a>4.d. Establishing default ARP&#39;s for the origin community</h4>
<p><b>For a more basic introduction to ARP&#39;s, please refer to section
<a href="#2.e.">2.e</a>.</b></p>
<blockquote>
    <p>An ARP determines which attributes are released to a SHAR when a user 
    tries to access a resource. It acts as a sort of filter on user information 
    contained in the authoritative directory, deciding what can be released to 
    whom, but not modifying or creating information itself. ARP&#39;s are generally 
    administered by the site, but Shibboleth will provide for users to broker 
    control of their own information and privacy by allowing them to create 
    ARP&#39;s pertaining to themselves.</p>
    <p>It is recommended that a set of policies be established between an origin 
    and frequently accessed targets to specify default releases of expected 
    attributes. Federation guidelines may provide more information on population 
    of ARP&#39;s.</p>
    <p>Currently, there is no direct mechanism for users to create their own 
    ARP&#39;s besides direct XML writing. In future versions, a GUI will be provided 
    for simpler management of ARP&#39;s. Care should be given to balancing giving 
    sufficient control over information to users and avoiding access problems. 
    For example, users may decide to restrict the release of their personal 
    information to such a degree that access to a site for a class may become 
    impossible because Shibboleth cannot release enough information to grant 
    access.</p>
    <p>The Shibboleth distribution contains an example site arp that releases 
    the eduPersonScopedAffiliation attribute to all targets. For more precise 
    information regarding how ARP&#39;s are processed or syntactically formed, 
    please refer to section <a href="#5.b.i.">5.b.i</a>.</p>
</blockquote>
<p><br>
</p>
<hr>
<p><br>
</p>
<h3><a name="5."></a>5. Advanced Configuration</h3>
<h4><a name="5.a."></a>5.a. <span class="fixedwidth">origin.xml</span></h4>
<blockquote>
    <p>Shibboleth 1.2 origins are configured using the <span class="fixedwidth">origin.xml</span> file located in
    <span class="fixedwidth">/webapps/shibboleth/WEB-INF/classes/conf/origin.xml</span>.  The XML consists of a set of individual elements that describe how the origin should operate, which may each have their own attributes or appear within other elements.  This structure is represented through cross-references in the definitions and the examples presented in <a href="#4.a.">section 4.a</a>, below, and through the <a href="http://marsalis.internet2.edu/cgi-bin/viewcvs.cgi/shibboleth/java/data/">examples in CVS</a>.
    The following is an alphabetical list of all configuration parameters and values. The configuration must be consistent with values elsewhere in the 
    deployment, such as certificates and keystores including the <a href="#4.c.">HS&#39; certificate</a> and with 
    directory access bindings, etc., or access errors may occur.  For a more basic example, consult <a href="#4.a.">section 4.a</a>.</p>
    <p>All pathnames are relative, and have an effective root path of
    <span class="fixedwidth">$TOMCAT_HOME/webapps/shibboleth/WEB-INF/classes/</span>. 
    To specify files outside of the webapp, specify a full URI, such as
    <span class="fixedwidth">file:///usr/local/shibboleth/</span>.</p>
    <p>All elements are optional unless otherwise specified.  All attributes of an element are optional unless designated <span class="mandatory">mandatory</span> by a purple background.</p>

    <dl>
        <dd class="attributelong"><a name="confArpRepository"><span class="fixedwidth">&lt;ArpRepository implementation =&quot;edu.internet2.middleware.shibboleth.aa.arp.provider.FileSystemArpRepository&quot;&gt;</span></dd>
        <dd class="value"><p>This element specifies an individual implementation
        of a release policy engine, with the given value specifying Shibboleth's
        file-based ARP repository implementation, which is currently the only
        available.  This must contain a <a href="#confPath"><span
        class="fixedwidth">Path</span></a> element pointing to the directory
        containing ARP's to be used by this engine.  For more information
        regarding ARP's, consult section <a href="#4.d.">4.d</a> for basic
        information and <a href="#5.b.">5.b</a> for advanced configuration and
        syntax.</p><p>Note that the set of principals that an ARP applies to is
        not expressed by the ARP itself, but rather the implementation of the
        ARP repository. For example, if the ARP repository were implemented in
        LDAP, the ARP&#39;s that apply to a user would be attributes of that
        user&#39;s personal LDAP entry, and the site ARP would be an attribute
        of an entry representing the site. While not performed by the built-in
        ARP repository, a repository implementation might also implement group
        ARP&#39;s; for example, in an LDAP directory, the user entry might have
        some group membership attributes that refer to group entries, and those
        group entries would have ARP attributes, and all those ARP&#39;s would
        be applicable.</p></dd>

        <dd class="attributelong"><a name="confCAPath"><span class="fixedwidth">&lt;CAPath&gt;<i>pathname</i>&lt;/CAPath&gt;</span></dd>
        <dd class="value">Paired with a <a href="#confPath"><span class="fixedwidth">Path</span></a> element and contained by a <a href="#confFileResolver"><span class="fixedwidth">FileResolver</span></a> element, this element allows for the specification of additional certificates in the chain up to the trust anchor.  As many <span class="fixedwidth">CAPath</span> elements as necessary to complete the chain may be specified.  The expectations of the target and the federation may determine the necessity for the use of this field.</dd>

        <dd class="attributelong"><a name="confCertAlias"><span class="fixedwidth">&lt;CertAlias&gt;<i>string</i>&lt;/CertAlias&gt;</span></dd>
        <dd class="value">Specifies the alias for the certificate 
        corresponding to the private key used by the HS.  If no alias is specified, defaults to the private key's alias.  Contained by the <a href="#confKeyStoreResolver"><span class="fixedwidth">KeyStoreResolver</span></a> element.</dd>

        <dd class="attributelong"><a name="confCertificate"><span class="fixedwidth">&lt;Certificate format=&quot;<i>type</i>&quot;&gt;</span></dd>
        <dd class="value">This specifies the certificate corresponding to this set of credentials.  The certificate itself must be referred to using a <a href="#confPath"><span class="fixedwidth">Path</span></a> element contained by this element.  If this certificate isn't self-signed or signed by a root familiar to the target, the files of certificates in the path to the root may be specified using one or more <a href="#confPath"><span class="fixedwidth">CAPath</span></a> elements.  Valid encodings are <span class="fixedwidth">PEM</span> and <span class="fixedwidth">DER</span>.  It resides within the <a href="#confFileResolver"><span class="fixedwidth">FileResolver</span> element and must be paired with the corresponding private key using the <a href="#confKey"><span class="fixedwidth">Key</span></a> element.</dd>

        <dd class="attributelong"><a name="confCredentials"><span class="fixedwidth">&lt;Credentials xmlns=&quot;urn:mace:shibboleth:credentials:1.0&quot;&gt;</span></dd>
        <dd class="value">This element is the container for credentials used by the credential mechanism specified by the <a href="#confShibbolethOriginConfig"><span class="fixedwidth">ShibbolethOriginConfig</span></a> element.  For most deployments, the URN should be <span class="fixedwidth"></span>.  It must contain one <a href="#confFileResolver"><span class="fixedwidth">FileResolver</span></a> element for flat key and certificate files or one <a href="#confKeyStoreResolver"><span class="fixedwidth">KeyStoreResolver</span></a> element for compound keystores.</dd>

        <dd class="attributelong"><a name="confErrorLog"><span class="fixedwidth">&lt;ErrorLog level=&quot;<i>level</i>&quot; location=&quot;<i>URL</i>&quot;&gt;</span></dd>
        <dd class="value">Paired with a <a href="#confTransactionLog"><span class="fixedwidth">TransactionLog</span></a> element, this will log any errors encountered by the origin above a certain logging threshold to a flat file at the referenced <span class="fixedwidth">URL</span>.  Valid levels in order of decreasing sensitivity are <span class="fixedwidth">DEBUG</span>, <span class="fixedwidth">INFO</span>, <span class="fixedwidth">WARN</span>, <span class="fixedwidth">ERROR</span>, and <span class="fixedwidth">FATAL</span>.  If no logging is desired, specify <span class="fixedwidth">OFF</span>; defaults to <span class="fixedwidth">WARN</span>.  Must be contained by a <a href="#confLogging"><span class="fixedwidth">Logging</span></a> element.</dd>

        <dd class="attributelong"><a name="confFileResolver"><span class="fixedwidth">&lt;FileResolver Id=&quot;<i>string</i>&quot;&gt;</span></dd>
        <dd class="value">This element defines a pair of files used to store a private key and certificate associated with a given identifier and is contained by the <a href="#confCredentials"><span class="fixedwidth">Credentials</span></a> element.  <a href="#confRelyingParty"><span class="fixedwidth">RelyingParty</span></a> elements will refer to these identifiers allowing multiple resolver elements to be used to specify different credential storage for different federations or target sites.  It must contain one <a href="#confKey"><span class="fixedwidth">Key</span></a> element and should contain one <a href="#confCertificate"><span class="fixedwidth">Certificate</span></a> element.</dd>

        <dd class="attributelong"><a name="confHSNameFormat"><span class="fixedwidth">&lt;HSNameFormat <span class="mandatory">nameMapping=&quot;<i>id</i>&quot;</span>/&gt;</span></dd>
        <dd class="value">Individual <a href="#confRelyingParty"><span class="fixedwidth">RelyingParty</span></a> elements may contain this element to specify the <a href="#confNameMapping"><span class="fixedwidth">NameMapping</span></a> element referenced by <span class="fixedwidth">id</span> to be used in generating subject names for this relying party.  If this element is not present, default Shibboleth handles will be used.</dd>

        <dd class="attributelong"><a name="confKey"><span class="fixedwidth">&lt;Key format=&quot;<i>type</i>&quot;&gt;</span></dd>
        <dd class="value">This specifies the file containing a private key to be used by a set of credentials.  Valid encodings are <span class="fixedwidth">PEM</span> and <span class="fixedwidth">DER</span>.  Keys are supported in a variety of formats: DER, PEM, encrypted PEM, PKCS8, and encrypted PKCS8.  It resides within the <a href="#confFileResolver"><span class="fixedwidth">FileResolver</span> element, should be paired with a <a href="#confCertificate"><span class="fixedwidth">Certificate</span></a> element, and contain a <a href="#confPath"><span class="fixedwidth">Path</span></a> element.</dd>

        <dd class="attributelong"><a name="confKeyAlias"><span class="fixedwidth">&lt;KeyAlias&gt;<i>string</i>&lt;/KeyAlias&gt;</span></dd>
        <dd class="value">Specifies the alias used for accessing the private 
        key.  Contained by the <a href="#confKeyStoreResolver"><span class="fixedwidth">KeyStoreResolver</span></a> element.</dd>

        <dd class="attributelong"><a name="confKeyPassword"><span class="fixedwidth">&lt;KeyPassword&gt;<i>string</i>&lt;/KeyPassword&gt;</span></dd>
        <dd class="value">Specifies the password used to retrieve the private 
        key.  Contained by the <a href="#confKeyStoreResolver"><span class="fixedwidth">KeyStoreResolver</span></a> element.</dd>

        <dd class="attributelong"><a name="confKeyStoreKeyAlias"><span class="fixedwidth">&lt;KeyStoreKeyAlias&gt;<i>string</i>&lt;/KeyStoreKeyAlias&gt;</span></dd>
        <dd class="value">Specifies the alias used for accessing the private 
        key.  Contained by the <a href="#confNameMapping"><span class="fixedwidth">NameMapping</span></a> element when a <span class="fixedwidth">CryptoHandleGenerator</span> type is specified.</dd>

        <dd class="attributelong"><a name="confKeyStoreKeyPassword"><span class="fixedwidth">&lt;KeyStoreKeyPassword&gt;<i>string</i>&lt;/KeyStoreKeyPassword&gt;</span></dd>
        <dd class="value">Specifies the password used to retrieve the private 
        key.  Contained by the <a href="#confNameMapping"><span class="fixedwidth">NameMapping</span></a> element when a <span class="fixedwidth">CryptoHandleGenerator</span> type is specified.</dd>

        <dd class="attributelong"><a name="confKeyStorePassword"><span class="fixedwidth">&lt;KeyStorePassword&gt;<i>string</i>&lt;/KeyStorePassword&gt;</span></dd>
        <dd class="value">Specifies the password to access the keystore containing the private key to be used for symmetric encryption.  Contained by the <a href="#confNameMapping"><span class="fixedwidth">NameMapping</span></a> element when a <span class="fixedwidth">CryptoHandleGenerator</span> type is specified.</dd>

        <dd class="attributelong"><a name="confKeyStorePath"><span class="fixedwidth">&lt;KeyStorePath&gt;<i>string</i>&lt;/KeyStorePath&gt;</span></dd>
        <dd class="value">Specifies the location of the keystore containing the private key to be used for symmetric encryption to pass handles between the HS and AA.  Contained by the <a href="#confNameMapping"><span class="fixedwidth">NameMapping</span></a> element when a <span class="fixedwidth">CryptoHandleGenerator</span> type is specified.</dd>

        <dd class="attributelong"><a name="confKeyStoreResolver"><span class="fixedwidth">&lt;KeyStoreResolver Id=&quot;<i>string</i>&quot; storeType=&quot;<i>type</i>&quot;&gt;</span></dd>
        <dd class="value">This element is contained by the <a href="#confCredentials"><span class="fixedwidth">Credentials</span></a> element and to specify a keystore that contains both the certificate and private key for a given set of credentials.  Typically, this will be a Java keystore, with a corresponding type of <span class="fixedwidth">JKS</span>.  <a href="#confRelyingParty"><span class="fixedwidth">RelyingParty</span></a> elements will refer to the <span class="fixedwidth">Id</span> allowing multiple resolver elements to be used to specify different credential storage for different federations or target sites.  It must contain one <a href="#confPath"><span class="fixedwidth">Path</span></a> element, one <a href="#confKeyAlias"><span class="fixedwidth">KeyAlias</span></a> element, and one <a href="#confStorePassword"><span class="fixedwidth">StorePassword</span></a> element; it may optionally contain a <a href="#confKeyPassword"><span class="fixedwidth">KeyPassword</span></a> element or a <a href="#confCertAlias"><span class="fixedwidth">CertAlias</span></a> element.</dd>

        <dd class="attributelong"><a name="confLog4JConfig"><span class="fixedwidth">&lt;Log4JConfig location=&quot;<i>pathname</i>&quot;/&gt;</span></dd>
        <dd class="value">This element informs Shibboleth to utilize Log4J as a logging system and points to the relevant configuration file using the <span class="fixedwidth">location</span> attribute.  A basic configuration is included with the distribution at <span class="fixedwidth">/WEB-INF/classes/conf/log4j.properties</span>.  This is set up to log to the console of the servlet container with a level of WARN, but there is also a commented-out example in the file to give a possible alternate configuration.  This element must be contained by a <a href="#confLogging"><span class="fixedwidth">Logging</span></a> element and may not be paired with a <a href="#confTransactionLog"><span class="fixedwidth">TransactionLog</span></a> or <a href="#confErrorLog"><span class="fixedwidth">ErrorLog</span></a> element.</dd>

        <dd class="attributelong"><a name="confLogging"><span class="fixedwidth">&lt;Logging&gt;</span></dd>
        <dd class="value">This container element identifies a logging method for both the HS and AA to use and may not occur more than once.  Three different logging methods may be specified depending on what is placed inside this element.  If nothing is specified, then all logs go to the container console.  If <a href="#confErrorLog"><span class="fixedwidth">ErrorLog</span></a> and <a href="#confTransactionLog"><span class="fixedwidth">TransactionLog</span></a> elements are present, more traditional logging flatfiles will be generated at the locations specified.  A <a href="#confLog4JConfig"><span class="fixedwidth">Log4JConfig</span></a> element instructs the origin to use Log4J logging.</dd>

        <dd class="attributelong"><a name="confNameMapping"><span class="fixedwidth">&lt;NameMapping xmlns=&quot;urn:mace:shibboleth:namemapper:1.0&quot;<br>
format=&quot;<i>URN</i>&quot;<br>
handleTTL=&quot;<i>seconds</i>&quot;<br>
id=&quot;<i>string</i>&quot;<br>
type=&quot;<i>type</i>&quot;/&gt;</span></dd>
        <dd class="value">This element defines a name mapping system to create SAML assertion subject names for users; in standard Shibboleth, this will be the creation of a handle to be given to the SHAR and shared with the AA.
<ul>
<li><span class="fixedwidth">format</span> should be populated with the URN <span class="fixedwidth">urn:mace:shibboleth:1.0:nameIdentifier</span> if traditional Shibboleth handles are used.</li>
<li><span class="fixedwidth">handleTTL</span> specifies in seconds how long a given handle will be considered valid; an expired handle will require the user to obtain a new handle and possibly re-authenticate.  This field is only valid if Shibboleth handles are being used, e.g. <span class="fixedwidth">format</span> is <span class="fixedwidth">urn:mace:shibboleth:1.0:nameIdentifier</span>.  Consult your federation guidelines for guidance on the population of this field.</li>
<li><span class="fixedwidth">id</span> is used by <a href="#confHSNameFormat"><span class="fixedwidth">HSNameFormat</span></a> elements to refer to this element and must be unique.</li>
<li><span class="fixedwidth">type</span> dictates how handles are passed to the AA.  The valid types are:<ul type="circle">
<li><span class="fixedwidth">CryptoHandleGenerator</span>: Shibboleth handles will be passed using symmetric encryption.  If this is specified, keystore information must be specified using one <a href="#confKeyStorePath"><span class="fixedwidth">KeyStorePath</span></a> element, one <a href="#confKeyStoreKeyAlias"><span class="fixedwidth">KeyStoreKeyAlias</span></a> element, one <a href="#confKeyStorePassword"><span class="fixedwidth">KeyStorePassword</span></a> element, and optionally a <a href="#confKeyStoreKeyPassword"><span class="fixedwidth">KeyStoreKeyPassword</span></a> element.</li>
<li><span class="fixedwidth">Principal</span>: Shibboleth will use the primary unique identifier for the individual and not generate a handle.</li>
<li><span class="fixedwidth">SharedMemoryShibHandle</span>: Shibboleth will use a shared in-memory repository.</li>
</ul></li>
</ul></dd>

        <dd class="attributelong"><a name="confPath"><span class="fixedwidth">&lt;Path&gt;<i>pathname</i>&lt;/Path&gt;</span></dd>
        <dd class="value">This mandatory element specifies the path to a file or directory utilized by other elements of the configuration.  It may be contained by various elements to point to different types of files required by the origin.</dd>

        <dd class="attributelong"><a name="confReleasePolicyEngine"><span class="fixedwidth">&lt;ReleasePolicyEngine&gt;</span></dd>
        <dd class="value">The <span class="fixedwidth">ReleasePolicyEngine</span> element is used to specify a class of release policy processing and enforcement and is not mandatory, defaulting to ???.  This should contain one <a href="#confArpRepository"><span class="fixedwidth">ArpRepository</span></a> element.</dd>

        <dd class="attributelong"><a name="confRelyingParty"><span class="fixedwidth">&lt;RelyingParty <span class="mandatory">name=&quot;<i>URN</i>&quot;</span><br>
AAsigningCredential=&quot;<i>string</i>&quot;<br>
AAUrl=&quot;<i>URL</i>&quot;<br>
defaultAuthMethod=&quot;<i>URN</i>&quot;<br>
passThruErrors=&quot;<i>true/false</i>&quot;<br>
providerId=&quot;<i>string</i>&quot;<br>
signAttrAssertions=&quot;<i>true/false</i>&quot;<br>
signAttrResponses=&quot;<i>true/false</i>&quot;<br>
signAuthAssertions=&quot;<i>true/false</i>&quot;<br>
signAuthResponses=&quot;<i>true/false</i>&quot;<br>
signingCredential=&quot;<i>string</i>&quot;&gt;</span></dd>
        <dd class="value"><p>The <span class="fixedwidth">RelyingParty</span> element is used to specify one or more relying parties that this origin must recognize.  This includes any federations the origin is a member of, any targets that have established bilateral agreements with the origin, or any other trust structure that origin must be aware of.  In addition to its attributes, this element may contain a <a href="#confHSNameMapping"><span class="fixedwidth">HSNameMapping</span></a> element to specify a naming mechanism for assertions sent to this relying party.</p><ul>

<li class="mandatory"><span class="fixedwidth">name</span>: Each <span class="fixedwidth">RelyingParty</span> element is differentiated by a URN specified in the <span class="fixedwidth">name</span> attribute.  A target will send a value for this attribute with the attribute request; if the URN sent matches the <span class="fixedwidth">name</span>, this element will be used in the transaction.  If there is no direct match, the origin uses metadata to try to find a federation that the service provider is a member of.</li>
<li><span class="fixedwidth">AAsigningCredential</span>: This attribute must equal the identifier of one of the <a href="#confFileResolver><span class="fixedwidth">FileResolver</span></a> Id's.  A separate set of credentials may be specified for the AA's signing of assertions/SSL session identification using this attribute, as opposed to the HS' signing of assertions.  If this is not specified for this <span class="fixedwidth">RelyingParty</span> element, but a <span class="fixedwidth">signingCredential</span> attribute is, that set of credentials will be used instead.  Ensure that the appropriate signing key is selected for each; an incorrect signing key will lead to trust failures.</li>
<li><span class="fixedwidth">AAUrl</span>: Different AA's may be specified for different relying parties using this attribute.  It over-rides, is populated, and operates in the same manner as the <span class="fixedwidth">AAUrl</span> attribute of the <a href="#confShibbolethOriginConfig"><span class="fixedwidth">ShibbolethOriginConfig</span></a> element.</li>
<li><span class="fixedwidth">defaultAuthMethod</span>: The value of this attribute represents the mechanism by which the user's authentication was performed.  It is used to populate <span class="fixedwidth">authenticationMethod</span> in SAML assertions passed to this relying party if no other authentication method is passed to the HS.  For a brief list of authentication methods, consult the same attribute as part of the <a href="#confShibbolethOriginConfig"><span class="fixedwidth">ShibbolethOriginConfig</span></a> element.</li>
<li><span class="fixedwidth">passThruErrors</span>: This boolean attribute determines whether the origin will relay errors in flows to this target for use in displaying these errors to the browser in the case of an unsuccessful transaction.</li>
<li><span class="fixedwidth">providerId</span>: If the origin must assert under a different name to this relying party, specify a <span class="fixedwidth">providerId</span> attribute which will over-ride the one specified in <a href="#confShibbolethOriginConfig"><span class="fixedwidth">ShibbolethOriginConfig</span></a>.</li>
<li><span class="fixedwidth">signAttrAssertions</span>: If this boolean attribute has a value of <span class="fixedwidth">true</span>, the attribute assertion within the SAML response will be signed.  This is mostly useful for using the attribute assertion in contexts outside of the response and defaults to <span class="fixedwidth">false</span>.</li>
<li><span class="fixedwidth">signAttrResponses</span>: If this boolean attribute has a value of <span class="fixedwidth">true</span>, the attribute response itself will be signed in addition to the security and authentication provided by the SSL session.  SAML responses contain one or more assertions.  Defaults to <span class="fixedwidth">false</span>; if true, an <span class="fixedwidth">https://</span> AAUrl may be redundant.</li>
<li><span class="fixedwidth">signAuthAssertions</span>: If this boolean attribute has a value of <span class="fixedwidth">true</span>, the authentication assertion within the SAML response will be signed.  This is mostly useful for using the authentication assertion in contexts outside of the response and defaults to <span class="fixedwidth">false</span>.</li>
<li><span class="fixedwidth">signAuthResponses</span>: If this boolean attribute has a value of <span class="fixedwidth">false</span>, the authentication response will not be signed.  SAML responses contain one or more assertions.  Defaults to <span class="fixedwidth">true</span>.</li>
<li><span class="fixedwidth">signingCredential</span>: This attribute must equal the identifier of one of the <a href="#confFileResolver><span class="fixedwidth">FileResolver</span></a> Id's.  This allows the origin to use different signing keys and certificates for exchanges with different federations or targets.  Ensure that the appropriate signing key is selected for each; an incorrect signing key will lead to trust failures.</li>
</ul>
</dd>

        <dd class="attributelong"><a name="confShibbolethOriginConfig"><span class="fixedwidth">&lt;ShibbolethOriginConfig<br>
<span class="mandatory">xmlns=&quot;urn:mace:shibboleth:origin:1.0&quot;<br>
xmlns:cred=&quot;urn:mace:shibboleth:credentials:1.0&quot;<br>
xmlns:name=&quot;urn:mace:shibboleth:namemapper:1.0&quot;<br>
xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;<br>
xsi:schemaLocation=&quot;urn:mace:shibboleth:origin:1.0 origin.xml&quot;</span><br>
<span class="mandatory">defaultRelyingParty=&quot;<i>URI</i>&quot;<br>
providerID=&quot;<i>URN</i>&quot;</span><br>
AAUrl=&quot;<i>URL</i>&quot;<br>
authHeaderName=&quot;<i>string</i>&quot;<br>
defaultAuthMethod=&quot;<i>URN</i>&quot;<br>
maxHSThreads=&quot;<i>integer</i>&quot;<br>
passThruErrors=&quot;<i>true/false</i>&quot;<br>
resolverConfig=&quot;<i>pathname</i>&quot;&gt;</span></dd>
        <dd class="value"><p>This is the primary element that defines an <span class="fixedwidth">origin.xml</span> file and is the container for every other element and must appear once and only once.  For most deployments, all the <span class="fixedwidth">xmlns</span> attributes, which specify the handlers for different aspects of origin operation, should remain unchanged.  The mandatory attributes must be changed before operating the origin.</p>
<ul>
<li class="mandatory"><span class="fixedwidth">defaultRelyingParty</span>: This specifies the relying party to use for a request when no <a href="#confRelyingParty"><span class="fixedwidth">RelyingParty</span></a> element's <span class="fixedwidth">name</span> attribute matches the policy URN of an incoming request.  Typically, this will be populated with the URN of a federation.</li>
<li class="mandatory"><span class="fixedwidth">providerID</span>: The origin uses this unique name to identify assertions it issues.  This will usually be assigned by a federation.</li>
<li><span class="fixedwidth">AAUrl</span> specifies the URL where the AA for this HS resides, which must be consistent with how it is defined in Tomcat.  Note that this <b>must</b> be an <span class="fixedwidth">https://</span> URL in order for the AA to know which SHAR is requesting attributes for ARP purposes.</li>
<li><span class="fixedwidth">authHeaderName</span>: If authentication methods are passed to the HS using an HTTP header variable other than the default, <span class="fixedwidth">SAMLAuthenticationMethod</span>, the name of the variable may be specified here.</li>
<li><span class="fixedwidth">defaultAuthMethod</span>: This specifies the authentication method that will be assumed if none is passed through and there is no overriding <span class="fixedwidth">defaultAuthMethod</span> specified for this target using a <a href="#confRelyingParty"><span class="fixedwidth">RelyingParty</span></a> element.  If neither this element nor the matching <a href="#confRelyingParty"><span class="fixedwidth">RelyingParty</span></a> element contains this attribute, a value of <span class="fixedwidth">urn:oasis:names:tc:SAML:1.0:am:unspecified</span> will be used for <span class="fixedwidth">authenticationMethod</span>.  Some common 
        authentication methods and corresponding URI&#39;s are listed below; for a 
        complete list, please consult section 7.1 of the SAML 1.1 core 
        specifications or your federation&#39;s guidelines.
        <table border="2" cellpadding="0" cellspacing="0">
            <tr>
                <td><span class="fixedwidth">
                urn:oasis:names:tc:SAML:1.0:am:password</span></td>
                <td>The authentication was performed using a password.</td>
            </tr>
            <tr>
                <td><span class="fixedwidth">urn:ietf:rfc:1510</span></td>
                <td>The authentication was performed using Kerberos.</td>
            </tr>
            <tr>
                <td><span class="fixedwidth">
                urn:oasis:names:tc:SAML:1.0:am:X509-PKI</span></td>
                <td>The authentication was performed using a certificate and key 
                issued to the end user. More specific forms of PKI 
                authentication such as SPKI and XKMS are also assigned URN&#39;s in 
                the SAML specs.</td>
            </tr>
        </table></li>
<li><span class="fixedwidth">maxHSThreads</span>: This attribute places a limit on the number of threads the handle service will spawn and may be useful for limiting the load of signing and other operations and improving performance.</li>
<li><span class="fixedwidth">passThruErrors</span>: This boolean attribute determines whether the origin will relay errors in flows to the target for use in displaying these errors to the browser in the case of an unsuccessful transaction.</li>
<li><span class="fixedwidth">resolverConfig</span> specifies the location of the configuration file for the resolver the AA uses to build attributes and if unspecified defaults to <span class="fixedwidth">/conf/resolver.xml</span>. For information on how to configure and use the attribute resolver, consult section <a href="4.e.">4.e</a>.</li>
</ul>
</dd>

        <dd class="attributelong"><a name="confStorePassword"><span class="fixedwidth">&lt;StorePassword&gt;<i>string</i>&lt;/StorePassword&gt;</span></dd>
        <dd class="value">Specifies the password for the keystore.  Contained by the <a href="#confKeyStoreResolver"><span class="fixedwidth">KeyStoreResolver</span></a> element.</dd>

        <dd class="attributelong"><a name="confTransactionLog"><span class="fixedwidth">&lt;TransactionLog location=&quot;<i>URL</i>&quot;&gt;</span></dd>
        <dd class="value">Paired with an <a href="#confErrorLog"><span class="fixedwidth">ErrorLog</span></a> element, this will log all transactions that the origin is involved in.  The information in this file is sensitive and may be useful for auditing and security purposes.  Must be contained by a <a href="#confLogging"><span class="fixedwidth">Logging</span></a> element.</dd>

    </dl>
</blockquote>
<p><br>
</p>
<h4><a name="5.b."></a>5.b. ARP Overview</h4>
<blockquote>
    <h5>This section applies primarily to the syntactic and technical details of 
    ARP&#39;s. For basic information on and explanation of what an ARP is and how it 
    should be managed, please refer to sections <a href="#2.e.">2.e</a> and
    <a href="#4.d.">4.d</a>.</h5>
    <p>Every ARP file contains one ARP. ARP&#39;s may be specified either as the 
    site ARP or user ARP&#39;s. The site ARP pertains to every principal for whom 
    the AA retrieves information; a user ARP applies only to the individual user 
    for whom it is defined. The set of principals to whom the ARP applies is 
    defined by the name of the ARP file: the site ARP is stored in
    <span class="fixedwidth">arp.site.xml</span> and user ARP&#39;s are stored as
    <span class="fixedwidth">arp.user.$PRINCIPALNAME.xml</span>. Up to two ARP&#39;s 
    will apply to a principal: the site ARP, and the user ARP for that 
    principal.</p>
    <p>Each ARP acts as a container that holds a set of ARP rules that are 
    applicable to the principals that ARP is effective for. Each ARP rule 
    specifies a single release policy within the ARP container pertaining to a 
    specific set of targets. This set of targets may be specified as a specific 
    SHAR, a SHAR tree, or a regular expression, and becomes the ARP rule&#39;s 
    target definition. Each ARP rule may contain specifications regarding the 
    release of any number of attribute values to requests matching that ARP rule 
    for that user. ARP rules may be flagged as default, implying that they are 
    always applied to any user matched by the ARP container. Note that ARP&#39;s may 
    also be used to restrict specific attribute/value pairs in addition to 
    restricting or releasing individual attributes.</p>
    <p>When a query is received, the AA generates an effective ARP, which is the 
    fully evaluated set of ARP rules regarding that SHAR based on all ARP 
    containers applicable to the principal. This effective ARP is then applied 
    to attribute values retrieved from the directory and the appropriate 
    assertion is constructed. Default rules are always included in construction 
    of the effective ARP.</p>
</blockquote>
<h4><a name="5.b.i."></a>5.b.i. ARP Processing</h4>
<blockquote>
    <blockquote>
        <p>When a request arrives from a particular SHAR, the applicable set of 
        ARP rules are parsed into an effective ARP. This parsing is done as 
        follows:</p>
        <ol type="1">
            <li>Identify all ARP&#39;s that should be applied to a particular 
            principal. This is done by isolating the files in the folder 
            specified by <span class="fixedwidth">
            edu.internet2.middleware.shibboleth.aa.arp.provider.FileSystemArpRepository.Path</span> 
            that have the name either arp.site.xml or 
            arp.user.$PRINCIPALNAME.xml.</li>
            <li>Find all ARP rules relevant to the query:
            <ol type="i">
                <li>Any ARP rules within the identified ARP&#39;s designated as 
                defaults are automatically included in the effective ARP without 
                performing any matching functions.</li>
                <li>For each non-default rule in each identified ARP, the 
                matching functions specified in the rule&#39;s target definition are 
                performed. A separate matching function is performed for the 
                requesting SHAR and the resource on behalf of which the SHAR is 
                making the request.</li>
                <li>Each matching function evaluates to <span class="fixedwidth">
                TRUE</span> if the match is successful or
                <span class="fixedwidth">FALSE</span> if it is unsuccessful. If 
                both functions evaluate to <span class="fixedwidth">TRUE</span>, 
                the rule is included in the Effective ARP.</li>
            </ol>
            </li>
            <li>Construct the Attribute Filter:
            <ol type="i">
                <li>For each attribute, compile a temporary list of associated 
                rules that includes all values with a release qualifier of
                <span class="fixedwidth">permit</span>.</li>
                <li>Subtract from this list all attribute values with rules 
                specifying a release qualifier of <span class="fixedwidth">deny</span>. 
                The resulting list represents the allowable release values for 
                the attribute and is used as a mask for the values which are 
                returned from the Attribute Resolver.</li>
                <li>If a statement specifies that all values should be 
                permitted, then specific <span class="fixedwidth">deny</span> 
                qualifiers for specific values should still be enforced. If a 
                statement specifies that all values should be denied, then
                <span class="fixedwidth">permit</span> qualifiers for specific 
                values will be ignored.</li>
            </ol>
            </li>
            <li>Using the mask and attributes returned from the Attribute 
            Resolver, an assertion is constructed.</li>
        </ol>
    </blockquote>
</blockquote>
<h4><a name="5.b.ii."></a>5.b.ii. ARP Syntax</h4>
<blockquote>
    <blockquote>
        <p>Each ARP is described by an XML file based on a standard
        <span class="fixedwidth">.xsd</span> schema. It consists of a standard
        <span class="fixedwidth">AttributeReleasePolicy</span> element 
        referencing the appropriate <span class="fixedwidth">xsi:schemaLocation</span> 
        and a self-explanatory <span class="fixedwidth">Description</span> 
        element followed by any number of <span class="fixedwidth">Rule</span> 
        elements. Each <span class="fixedwidth">Rule</span> element must consist 
        of a <span class="fixedwidth">Target</span> element and one or more
        <span class="fixedwidth">Attribute</span> elements. The
        <span class="fixedwidth">Target</span> element specifies the rules by 
        which the target definition is formed. The <span class="fixedwidth">
        Attribute</span> elements specifies the name and values of the 
        attributes that may be released.</p>
        <p>The simplest possible ARP is as follows, which releases
        <span class="fixedwidth">eduPersonScopedAffiliation</span> to any target 
        for the users the ARP applies to:</p>
        <blockquote>
            <p><span class="fixedwidth">&lt;?xml version=&quot;1.0&quot;?&gt;<br>
            &lt;AttributeReleasePolicy xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; 
            xmlns=&quot;urn:mace:shibboleth:arp:1.0&quot; xsi:schemaLocation=&quot;urn:mace:shibboleth:arp:1.0 
            shibboleth-arp-1.0.xsd&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;Description&gt;Simplest possible 
            ARP.&lt;/Description&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;Rule&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
            &lt;Target&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;AnyTarget/&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
            &lt;/Target&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
            &lt;Attribute name=&quot;urn:mace:dir:attribute-def:eduPersonScopedAffiliation&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;AnyValue release= &quot;permit&quot;/&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
            &lt;/Attribute &gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/Rule &gt;<br>
            &lt;/AttributeReleasePolicy&gt;<br>
            </span></p>
        </blockquote>
    </blockquote>
    <p>All ARP&#39;s must take the same basic form. A detailed description of how 
    each element of the <span class="fixedwidth">Rule</span> element may be 
    sub-populated follows:</p>
    <p>The <span class="fixedwidth">Target</span> element:</p>
    <blockquote>
        <p><span class="fixedwidth">Target</span> may contain either the
        <span class="fixedwidth">AnyTarget</span> element, which will cause the
        <span class="fixedwidth">Target</span> to always return
        <span class="fixedwidth">TRUE</span>, or both the
        <span class="fixedwidth">Requester</span> element, which provides for 
        matches to be performed against the SHAR name and the
        <span class="fixedwidth">Resource</span> element, which provides for 
        matches to be performed against the requested URL.</p>
        <p>There are three matches that may be performed by the AA in evaluating 
        ARP&#39;s by using the <span class="fixedwidth">matchFunction</span> 
        component of the <span class="fixedwidth">Requester</span> and
        <span class="fixedwidth">Resource</span> elements. The following match 
        patterns may be specified directly following the
        <span class="fixedwidth">Requester</span> or <span class="fixedwidth">
        Resource</span> elements, such as <span class="fixedwidth">&lt;Requester 
        matchFunction=&quot;urn:mace:shibboleth:arp:matchFunction:regexMatch&quot;&gt;</span>:</p>
        <ul type="disc">
            <li><span class="fixedwidth">
            urn:mace:shibboleth:arp:matchFunction:exactShar </span>
            <blockquote>
                <p>May be used with the <span class="fixedwidth">Requester</span> 
                element.</p>
                <p>Evaluates to <span class="fixedwidth">TRUE</span> when the 
                string content of the <span class="fixedwidth">Requester</span> 
                element matches exactly the name of the requesting SHAR. 
                Otherwise evaluates to <span class="fixedwidth">FALSE</span>. 
                Serves as the default value associated with
                <span class="fixedwidth">Requester</span> if none is specified.</p>
            </blockquote>
            </li>
            <li><span class="fixedwidth">
            urn:mace:shibboleth:arp:matchFunction:resourceTree </span>
            <blockquote>
                <p>May be used with the <span class="fixedwidth">Resource</span> 
                element.</p>
                <p>Evaluates to <span class="fixedwidth">TRUE</span> when the 
                location of the resource either matches exactly or begins with 
                the string content of the <span class="fixedwidth">Resource</span> 
                element. Otherwise evaluates to <span class="fixedwidth">FALSE</span>.</p>
            </blockquote>
            </li>
            <li><span class="fixedwidth">
            urn:mace:shibboleth:arp:matchFunction:regexMatch </span>
            <blockquote>
                <p>May be used with both the <span class="fixedwidth">Requester</span> 
                and <span class="fixedwidth">Resource</span> elements.</p>
                <p>Evaluates to <span class="fixedwidth">TRUE</span> when the 
                name of the requesting SHAR or the requested URL tree is a valid 
                match of the regular expression represented as the content of 
                the containing element. Otherwise evaluates to
                <span class="fixedwidth">FALSE</span>. Regular expressions are 
                evaluated in accordance with the the
                <a href="http://java.sun.com/j2se/1.4.2/docs/api/java/util/regex/package-summary.html">
                Java 1.4 Pattern API</a>.</p>
            </blockquote>
            </li>
        </ul>
    </blockquote>
    <p>The <span class="fixedwidth">Attribute</span> element:</p>
    <blockquote>
        <p>The <span class="fixedwidth">Attribute</span> element must always 
        specify the URN of the attribute whose release parameters it specifies. 
        Additionally, it must contain either the <span class="fixedwidth">
        AnyValue</span> element or one or more <span class="fixedwidth">Value</span> 
        elements. These elements, in turn, must specify either
        <span class="fixedwidth">release</span> = <span class="fixedwidth">
        permit</span> or <span class="fixedwidth">deny</span>. The
        <span class="fixedwidth">Value</span> element must then contain one 
        value for which the rule applies. Examples:</p>
        <blockquote>
            <p><span class="fixedwidth">&lt;Attribute name=&quot;urn:mace:dir:attribute-def:eduPersonPrincipalName&quot;&gt;<br>
            &nbsp;&nbsp;&lt;AnyValue release=&quot;Permit&quot;&gt;<br>
            &lt;/Attribute&gt;<br>
            </span><br>
            </p>
            <p>Permits the release of <span class="fixedwidth">
            eduPersonPrincipalName</span> with any value.</p>
        </blockquote>
        <blockquote>
            <p><span class="fixedwidth">&lt;Attribute name=&quot;urn:mace:dir:attribute-def:eduPersonScopedAffiliation&quot;&gt;<br>
            &nbsp;&nbsp;&lt;Value release=&quot;deny&quot;&gt;member@example.edu&lt;/Value&gt;<br>
            &lt;/Attribute&gt;<br>
            </span><br>
            </p>
            <p>Denies the release of <span class="fixedwidth">
            eduPersonScopedAffiliation</span> value <span class="fixedwidth">
            member@example.edu</span>. Other values of the attribute may still 
            be released if so specified by a <span class="fixedwidth">permit</span> 
            ARP.</p>
        </blockquote>
    </blockquote>
    <!-- ##To be included in future releases.  Not yet implemented.
      
      <p>There is also a special <span class="fixedwidth">AttributeIdentifier</span>
      element that allows internal references to an attribute
      within an ARP.  This is useful for quickly applying multiple
      rules to the same target.  It is used as follows:</p>

        <blockquote>
          <span class="fixedwidth">
          &nbsp;&nbsp;&lt;Rule&gt;<br>
          
          &nbsp;&nbsp;&nbsp;&nbsp;&lt;Target&gt;<br>
          
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;AnyTarget/&gt;<br>
          
          &nbsp;&nbsp;&nbsp;&nbsp;&lt;/Target&gt;<br>
          
          &nbsp;&nbsp;&nbsp;&nbsp;&lt;Attribute
          name=&quot;urn:mace:dir:attribute-def:eduPersonScopedAffiliation&quot;&gt;<br>

          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;Value
          release=&quot;permit&quot;&gt;member@example.edu&lt;/Value
          &gt;<br>

          &nbsp;&nbsp;&nbsp;&nbsp;&lt;/Attribute&gt;<br>
          
          &nbsp;&nbsp;&lt;/Rule&gt;<br>
          
          &nbsp;&nbsp;&lt;AttributeReference identifier=&quot;http://www.example.edu/attributes/attribute1&quot;&gt;<br>

          &nbsp;&nbsp;&lt;Attribute name=&quot;urn:mace:dir:attribute-def:eduPersonScopedAffiliation&quot; identifier=&quot;http://www.example.edu/attributes/attribute1&quot;&gt;<br>

          &nbsp;&nbsp;&nbsp;&nbsp;&lt;Value release=&quot;permit&quot;&gt;student@example.edu&lt;Value&gt;<br>

          &nbsp;&nbsp;&lt;/Attribute&gt;<br>
          </span>
      -->
</blockquote>
<h4><a name="5.c."></a>5.c. Sharing certificate/key pairs between Apache and 
Java keystores <font color="#5555EE">(optional)</font></h4>
<blockquote>
    <blockquote>
        <p>The JDK includes the command line program <span class="fixedwidth">
        keytool</span> for managing Java keystores. This utility cannot import 
        or export private key information, making it difficult to use the same 
        private key and certificate for Apache and Java-based applications. The 
        Shibboleth distribution includes <span class="fixedwidth">extkeytool</span>, 
        a program that can be used in conjunction with <span class="fixedwidth">
        keytool</span> to perform these tasks. Select the appropriate 
        step-by-step procedure for your situation from the following guides.</p>
        <p>Before running <span class="fixedwidth">extkeytool</span>, the 
        variable SHIB_HOME must be set to the path to the directory where the 
        Shibboleth tarball was exploded(typically /opt/shibboleth-origin-1.1/).</p>
        <p><b>If you have a pre-exiting RSA key/certificate combination in a 
        keystore and you would like to use it with Apache:</b></p>
        <ol type="1">
            <li>Determine the alias of the keystore keyEntry containing the key 
            you would like to use in your Apache setup. Assuming that your 
            keystore is named <span class="fixedwidth">yourstore</span>, the 
            following command should present a list of the entries in the 
            keystore.<blockquote>
                <p><span class="fixedwidth">$ keytool -list -v -keystore 
                yourstore</span></p>
            </blockquote>
            </li>
            <li>Assuming that you identified the appropriate alias as
            <span class="fixedwidth">youralias</span> and the password for the 
            keystore is <span class="fixedwidth">yourpass</span>, enter the 
            following command to export the key in Base64-encoded pkcs8 format.<blockquote>
                <p><span class="fixedwidth">$ extkeytool -exportkey -keystore 
                yourstore -alias youralias -storepass yourpass -rfc -file 
                yourkey.pkcs8</span></p>
            </blockquote>
            </li>
            <li>In order to use this key with Apache, you must convert it to PEM-encoded 
            RSA native format. You have the option of storing the key 
            unencrypted or encrypted:<ol type="A">
                <li>To use the unencrypted format, enter the following command 
                for the conversion:<blockquote>
                    <p><span class="fixedwidth">$ openssl pkcs8 -in 
                    yourkey.pkcs8 -nocrypt|openssl rsa -out yourkey.key</span></p>
                </blockquote>
                </li>
                <li>To use the encrypted format, enter the following command for 
                the conversion:<blockquote>
                    <p><span class="fixedwidth">$ openssl pkcs8 -in 
                    yourkey.pkcs8 -nocrypt|openssl rsa -des3 -out yourkey.enckey</span></p>
                </blockquote>
                </li>
            </ol>
            </li>
            <li>The following command will export the corresponding certificate.<blockquote>
                <p><span class="fixedwidth">$ keytool -export -keystore 
                yourstore -alias youralias -rfc -file yourcert</span></p>
            </blockquote>
            </li>
            <li>Set the <span class="fixedwidth">mod_ssl</span>
            <span class="fixedwidth">SSLCertificateKeyFile</span> and
            <span class="fixedwidth">SSLCertificateFile</span> directives to 
            point to the two files you have just created. Take care to remove 
            any temporary files you created (i.e. <span class="fixedwidth">
            yourkey.pkcs8</span>) and set appropriate file permissions, 
            especially if you chose to store the key in an unencrypted format.</li>
        </ol>
        <p><b>If you have a pre-existing RSA key/certificate combination that 
        you use with Apache and would like to import it into a java keystore:</b></p>
        <ol type="1">
            <li>Convert the private key to unencrypted DER-encoded pkcs8 format. 
            Assuming your PEM-encoded key is stored in a file named
            <span class="fixedwidth">yourkey.enckey</span>, enter the following 
            command.<blockquote>
                <p><span class="fixedwidth">$ openssl pkcs8 -in yourkey.enckey 
                -topk8 -nocrypt -outform DER -out yourkey.der.pkcs8</span></p>
            </blockquote>
            </li>
            <li>Create a certificate bundle file. This file should include a 
            series of PEM-encoded X509 certificates representing a complete 
            trust chain, from the root CA certificate to the certificate that 
            matches your private key. If your certificate is stored in a file 
            named <span class="fixedwidth">mycert</span> and the CA signer 
            certificate is stored in a file named <span class="fixedwidth">
            ca.cert</span>, you might enter the following command to create the 
            bundle.<blockquote>
                <p><span class="fixedwidth">$ cat mycert ca.cert &gt; cert.bundle</span></p>
            </blockquote>
            <p><b>Note: <span class="fixedwidth">mod_ssl</span>-enabled Apache 
            installations include a number of commonly recognized CA 
            certificates in the <span class="fixedwidth">ca-bundle.crt</span> 
            file under the <span class="fixedwidth">$ServerRoot/conf/ssl.crt/</span> 
            directory.</b> </li>
            <li>Import the key and certificate into the keystore. Assuming you 
            have already created a keystore named <span class="fixedwidth">
            yourstore</span> with a password of of <span class="fixedwidth">
            yourpass</span>, enter the following command to store the data under 
            the alias <span class="fixedwidth">youralias</span>.<blockquote>
                <p><span class="fixedwidth">$ ./extkeytool -importkey -keystore 
                yourstore -alias youralias -storepass yourpass -keyfile 
                yourkey.der.pkcs8 -certfile cert.bundle -provider 
                org.bouncycastle.jce.provider.BouncyCastleProvider</span></p>
            </blockquote>
            </li>
            <li>You can verify that the import was successful by listing entry. 
            Use the command below.<blockquote>
                <p><span class="fixedwidth">$ keytool -list -v -keystore 
                yourstore -alias youralias</span></p>
            </blockquote>
            </li>
            <li>Remember to delete <span class="fixedwidth">yourkey.der.pkcs8</span>, 
            as it contains your unencrypted private key.</li>
        </ol>
        <p><b>If you are starting from scratch and do not yet have a 
        certificate/key pair:</b></p>
        <ol type="1">
            <li>Generate an RSA private key. Use the command below, substituting
            <span class="fixedwidth">yourkey</span> with an appropriate name to 
            use to refer to the key.<blockquote>
                <p><span class="fixedwidth">$ openssl genrsa -des3 -out 
                yourkey.enckey 1024</span></p>
            </blockquote>
            </li>
            <li>The following command generates a Certificate Signing Request, 
            which should be communicated to a Certificate Authority.<blockquote>
                <p><span class="fixedwidth">$ openssl req -new -key 
                yourkey.enckey</span></p>
            </blockquote>
            </li>
            <li>The Certificate Authority should respond with a PEM-encoded X509 
            certificate. Set the <span class="fixedwidth">mod_ssl</span>
            <span class="fixedwidth">SSLCertificateKeyFile</span> directive to 
            point to the key file you just created and the
            <span class="fixedwidth">SSLCertificateFile</span> directive to 
            point to file containing the certificate issued by the Certificate 
            Authority. Previous sections explaion how to share the 
            key/certificate pair with a Java keystore.</li>
        </ol>
    </blockquote>
</blockquote>
<p><br>
</p>
<h4><a name="5.d."></a>5.d. The Attribute Resolver</h4>
<blockquote>
    <p>Shibboleth provides a powerful attribute resolver that allows origins to 
    quickly configure the retrieval of simple attributes from standard types of 
    attribute stores. The resolver is configured using an xml file wich should 
    be pointed to with the <span class="fixedwidth">
    edu.internet2.middleware.shibboleth.aa. 
    attrresolv.AttributeResolver.ResolverConfig</span> propety in
    <span class="fixedwidth">origin.properties</span> as described in section
    <a href="#4.a.">4.a</a>. For more complex attributes or those that require 
    processing before release, customized Java classes will need to be written. 
    For more information, consult the programmer&#39;s guide.</p>
    <p>The resolver is essentially a directed graph from attribute definitions 
    to data connectors. The data connectors pull data, in the form of 
    attributes, from external data sources. The attribute definitions then 
    process this data into a from suitable for use by Shibboleth. This procedure 
    can be as simple as taking an unmodified string value from a data connector 
    and tagging it with a name or can include arbitrarily complex business 
    rules.</p>
    <p>The <span class="fixedwidth">resolver.xml</span> file that is pointed to 
    by <span class="fixedwidth">origin.properties</span> consists of zero or 
    more attribute definitions followed by zero or more data connectors. Each 
    attribute definition consists of an identifier corresponding to the URN of 
    the attribute, and optional references to data connectors on which it 
    depends. Each data connector consists of a string identifier which is used 
    by attribute definitions that refer to it, and one or more elements specific 
    to the configuration of that data connector.</p>
    <p>Shibboleth comes with two attribute definitions provided in version 1.1: 
    the <span class="fixedwidth">SimpleAttributeDefinition</span>, which acts as 
    a basic proxy for attributes supplied by data connectors with some name 
    conversion and attribute scoping added, and a <span class="fixedwidth">
    CustomAttributeDefinition</span>, which can be used to configure 
    user-created attribute definition plugins. Similarly, Shibboleth 1.1 comes 
    with two data connectors: the <span class="fixedwidth">
    JNDIDirectoryDataConnector</span>, which pulls data from any source for 
    which there is a JNDI Directory Context implementation, including LDAP, NDS, 
    etc., and the <span class="fixedwidth">CustomDataConnector</span>, which is 
    used to configure user-created data connector plugins.</p>
    <p>A detailed explanation of each configuration option for the provided 
    connectors follows:</p>
    <p><span class="fixedwidth">JNDIDirectoryDataConnector</span>:</p>
    <dl>
        <dd class="attribute"><span class="fixedwidth">id = &lt;string&gt;</span> </dd>
        <dd class="value">Specifies a unique, textual name for the connector 
        used by attribute definitions to refer to and use it to build 
        attributes. Contained within the <span class="fixedwidth">
        JNDIDirectoryDataConnector</span> element.</dd>
        <dd class="attribute"><span class="fixedwidth">&lt;Property name=&quot;&lt;name&gt;&quot; 
        value=&quot;&lt;value&gt;&quot;/&gt;</span> </dd>
        <dd class="value">An element of the element <span class="fixedwidth">
        JNDIDirectoryDataConnector</span>. Specifies a set of name/value pairs 
        that are used to configure the JNDI Directory Context. This list of 
        name/value pairs is defined by the context itself, but is specified 
        within <span class="fixedwidth">resolver.xml</span>. Refer to the
        <a href="http://http://marsalis.internet2.edu/cgi-bin/viewcvs.cgi%20%20%20%20%20%20%20%20%20%20/shibboleth/java/src/conf/resolver.ldap.xml">
        Shibboleth CVS</a> for an example of names and values used to connect to 
        an LDAP directory.</dd>
        <dd class="attributeopt"><span class="fixedwidth">&lt;Search&gt;</span> </dd>
        <dd class="valueopt">An element of the element <span class="fixedwidth">
        JNDIDirectoryDataConnector</span>. This element defines the DN filter 
        used to perform the LDAP search. The search string must return no more 
        than one result.</dd>
        <dd class="attributeopt"><span class="fixedwidth">&lt;Controls&gt;</span> </dd>
        <dd class="valueopt">An element of the element <span class="fixedwidth">
        Search</span>. This element grants some fine-grained control over the 
        LDAP API calls.</dd>
        <dd class="attributeopt"><span class="fixedwidth">&lt;cacheTime 
        &quot;&lt;seconds&gt;&quot;/&gt;</span> </dd>
        <dd class="valueopt">An element of the element <span class="fixedwidth">
        JNDIDirectoryDataConnector</span>. Specifies an optional duration in
        <span class="fixedwidth">seconds</span> for which the attribute resolver 
        may cache information retrieved from this connector. The default is zero seconds (no caching)</dd>
    </dl>
    <p>A representation of a properly constructed <span class="fixedwidth">
    JNDIDirectoryDataConnector</span> element would look like:</p>
    <blockquote>
        <p><span class="fixedwidth">&lt;JNDIDirectoryDataConnector id=&quot;directory&quot;&gt;<br>
        &nbsp;&nbsp;&lt;Search filter=&quot;cn=%PRINCIPAL%&quot;&gt;<br>
        &nbsp;&nbsp;&nbsp;&nbsp;&lt;Controls searchScope=&quot;SUBTREE_SCOPE&quot; returningObjects=&quot;false&quot; /&gt;<br>
        &nbsp;&nbsp;&lt;/Search&gt;<br>
        &nbsp;&nbsp;&lt;Property name=&quot;java.naming.factory.initial&quot; value=&quot;com.sun.jndi.ldap.LdapCtxFactory&quot; 
        /&gt;<br>
        &nbsp;&nbsp;&lt;cacheTime=&quot;2400&quot;/&gt;<br>
        &lt;/JNDIDirectoryDataConnector&gt; </span></p>
    </blockquote>
    <p>If the ldap server must be accessed over SSL, and JDK 1.4.1 is being used, two changes must be made to the <span class="fixedwidth">JNDIDirectoryDataConnector</span> element:</p>
	<p>1. On the java.naming.provider.url Property, add &lt;port number&gt; after the hostname in the ldap url (the default port for ldap over SSL is 636),</p>
	<p>2. Add this Property element:</p>
    <blockquote>
		<p><span class="fixedwidth">&lt;Property name="java.naming.security.protocol" value="ssl" &quot;&gt;</span></p>
	</blockquote>
	<p>If the ldap server must be accessed over SSL, and JDK 1.4.2 is being used, then change ldap:// to ldaps:// in the value of the <span class="fixedwidth">java.naming.provider.url</span> Property.</p>
	<p>NOTE: This assumes that the ldap server's cert is rooted with a CA that is in the JVM's default keystore (ie: a commercial CA).  If not, the CA cert must be added.</p>
    <p><span class="fixedwidth">SimpleAttributeDefinition</span>:</p>
    <dl>
        <dd class="attribute"><span class="fixedwidth">id = &lt;string&gt;</span> </dd>
        <dd class="value">Specifies a unique, textual name for the attribute 
        which is used as the attribute&#39;s name when it is sent over the wire by 
        Shibboleth. Contained within the <span class="fixedwidth">
        SimpleAttributeDefinition</span> element.</dd>
        <dd class="attributeopt"><span class="fixedwidth">&lt;AttributeDependency / 
        DataConnectorDependency requires=&quot;&lt;id&gt;&quot;/&gt;</span> </dd>
        <dd class="valueopt">An element of the element <span class="fixedwidth">
        SimpleAttributeDefinition</span>, which may contain 0 or more of either
        <span class="fixedwidth">AttributeDependency</span> or
        <span class="fixedwidth">DataConnectorDependency</span>. These specify 
        attributes and data connectors that can be utilized by this attribute 
        definition. Each of these elements must contain a
        <span class="fixedwidth">requires</span> statement which this attribute 
        definition can then use to build its value.</dd>
        <dd class="attributeopt"><span class="fixedwidth">smartScope = 
        &quot;&lt;domain&gt;&quot;</span> </dd>
        <dd class="valueopt">Specifes a domain scope to be attached to the 
        attribute. If the value of the attribute as retrieved from the data 
        connector includes a pre-existing scope (<span class="fixedwidth">bob@foo.edu</span>), 
        that scope is used instead. Contained within the
        <span class="fixedwidth">SimpleAttributeDefinition</span> element.</dd>
        <dd class="attributeopt"><span class="fixedwidth">&lt;lifeTime 
        &quot;&lt;seconds&gt;&quot;/&gt;</span> </dd>
        <dd class="valueopt">Specifies in the attribute assertion 
        how long the attribute should be cached and retained by the target upon 
        receipt. Federations and trust agreements may have some bearing on the 
        population and use of this field. Contained within the
        <span class="fixedwidth">SimpleAttributeDefinition</span> element.</dd>
        <dd class="attributeopt"><span class="fixedwidth">sourceName = 
        &quot;&lt;string&gt;&quot;</span> </dd>
        <dd class="valueopt">Specifies a different source attribute name to be 
        used in calls to the data connector, while the name on the wire will be 
        the specified <span class="fixedwidth">id</span>. This would be useful 
        to send a local UniversityID attribute as eduPersonPrincipalName. If not 
        supplied, the connector tokenizes the <span class="fixedwidth">id</span> 
        field and uses the section following the <span class="fixedwidth">#</span> 
        to query data connectors. Contained within the <span class="fixedwidth">
        SimpleAttributeDefinition</span> element.</dd>
        <dd class="attributeopt"><span class="fixedwidth">&lt;cacheTime 
        &quot;&lt;seconds&gt;&quot;/&gt;</span> </dd>
        <dd class="valueopt">Specifies an optional duration in
        <span class="fixedwidth">seconds</span> for which the attribute resolver 
        may cache this attribute for use in additional assertions.  Contained within
        the <span class="fixedwidth">SimpleAttributeDefinition</span> element.</dd>
    </dl>
    <p>A representation of a properly constructed <span class="fixedwidth">
    SimpleAttributeDefinition</span> element would look like:</p>
    <blockquote>
        <p><span class="fixedwidth">&lt;SimpleAttributeDefinition id=&quot;urn:mace:dir:attribute-def:eduPersonPrincipalName&quot;<br> 
        smartScope=&quot;shibdev.edu&quot; cacheTime=&quot;600&quot; lifeTime=&quot;3600&quot;  sourceName=&quot;universityPerson&quot;&gt;<br>
        &nbsp;&nbsp;&lt;DataConnectorDependency requires=&quot;dataConnector&quot;/&gt;<br>
        &nbsp;&nbsp;&lt;AttributeDependency requires=&quot;urn:mace:dir:attribute-def:eduPersonScopedAffiliation&quot;/&gt;<br>
        &lt;/SimpleAttributeDefinition&gt; </span></p>
    </blockquote>
    <p>A properly formed <span class="fixedwidth">resolver.xml</span> file to 
    automatically generate a simple response for EPPN may take the form:</p>
    <blockquote>
        <p><span class="fixedwidth">&lt;AttributeResolver xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; 
        xmlns=&quot;urn:mace:shibboleth:resolver:1.0&quot; xsi:schemaLocation=&quot;urn:mace:shibboleth:resolver:1.0 
        shibboleth-resolver-1.0.xsd&quot;&gt;<br>
        <br>
        &nbsp;&nbsp;&lt;SimpleAttributeDefinition id=&quot;urn:mace:dir:attribute-def:eduPersonPrincipalName&quot; 
        smartScope=&quot;shibdev.edu&quot;&gt;<br>
        &nbsp;&nbsp;&nbsp;&nbsp;&lt;DataConnectorDependency requires=&quot;echo&quot;/&gt;<br>
        &nbsp;&nbsp;&lt;/SimpleAttributeDefinition&gt;<br>
        <br>
        &nbsp;&nbsp;&lt;CustomDataConnector id=&quot;echo&quot; 
        class=&quot;edu.internet2.middleware.shibboleth.aa.attrresolv.provider.SampleConnector&quot; 
        /&gt;<br>
        &lt;/AttributeResolver&gt; </span></p>
    </blockquote>
    <p>There are additional examples of <span class="fixedwidth">resolver.xml</span> 
    files provided in the
    <a href="http://marsalis.internet2.edu/cgi-bin/viewcvs.cgi/shibboleth/java/src/conf/">
    Shibboleth CVS</a>.</p>
</blockquote>
<p><br>
</p>
<h4><a name="5.d.i."></a>5.d.i <span class="fixedwidth">resolvertest</span></h4>
<blockquote>
    <p>Shibboleth comes bundled with the command line utility
    <span class="fixedwidth">resolvertest</span> for testing Attribute Resolver 
    configurations. This program takes as input <span class="fixedwidth">
    resolver.xml</span>, the name of a user, and optionally the name of a 
    requesting SHAR. It outputs the resulting SAML &lt;Attribute /&gt; elements. This 
    allows administrators to view the results of tweaking the resolver 
    configuration without having to continually reload the origin web 
    application. <span class="fixedwidth">resolvertest</span> is also useful for testing when the AA  is first configured to use an attribute repository (ldap or sql). Initially, the following two steps must be performed:</p>
    <ol>
        <li>Set the shell variable <span class="fixedwidth">SHIB_HOME</span> to 
        the directory path where the Shibboleth tarball was exploded (typically
        <span class="fixedwidth">/opt/shibboleth-origin-1.1/</span>).</li>
        <li>Move to $SHIB_HOME/bin</li>
    </ol>
    <p><span class="fixedwidth">resolvertest</span> may then be used by 
    executing the shell script, passing the name of a user and a URL to the 
    Attribute Resolver configuration file as parameters. For example:</p>
    <blockquote>
        <p><span class="fixedwidth">$ ./resolvertest --user=wassa 
        --file=file:///$SHIB_HOME/src/conf/resolver.xml</span></p>
    </blockquote>
    <h5>NOTE: This program does not filter the resulting attributes through the 
    applicable ARP&#39;s. Although it does show the attributes generated by the 
    resolver for a particular user or URL, it does not necessarily reflect what 
    will be released by the AA to a requesting SHAR.</h5>
</blockquote>
<p><br>
</p>
<h4><a name="5.e."></a>5.e. Local Error Page</h4>
<blockquote>
    <p>Origin sites are encouraged to provide federations with the URL of a 
    local Shibboleth error page. If a browser user from the origin site 
    encounters a problem at a shibbolized target, the target is likely to 
    display an error page that includes a link back to this origin provided 
    page.</p>
    <p>The page should provide information on how to obtain local support for 
    using Shibbolized resources. It might also include suggestions on what 
    information should be recorded before beginning the problem resolution 
    process.</p>
</blockquote>
<p><br>
<br>
</p>
<h4><a name="5.f."></a>5.f. Using a New Attribute</h4>
<p>In order for an attribute to be sent to a target, two steps are required:</p>
<p>1. The attribute has to be defined in resolver.xml. See section <a href="#5.d.">5.d</a>.</p>
<p>2. The effective ARP for that target has to release this attribute value. See section <a href="#5.b.">5.b.</a>.</p>
<p>Note: resolvertest is a useful tool for verifying the correctness of the definitions.</p>
<p>Note: the AAP at the target must also define this attribute. See the Shibboleth Target Deploy Guide.</p>

<p><br>
<br>
</p>
<hr>
<p><br>
</p>
<h3><a name="6."></a>6. Troubleshooting</h3>
<p>This section provides basic information about testing, logging, and error 
handling for Shibboleth origins. This information is not intended to be 
comprehensive, but instead rudimentary guidelines for basic configuration tests 
and problems. For more detailed information or answers to specific problems not 
addressed in this section, please mail
<a href="mailto:mace-shib-users@internet2.edu">mace-shib-users@internet2.edu</a> 
with a thorough description of errors and configurations used.</p>
<h4><a name="6.a."></a>6.a. Basic Testing</h4>
<blockquote>
    <p>Internet2 provides a basic target that can be used to test origin setup 
    functionality. After your origin is recognized by InQueue, simply use any 
    browser to access <a href="https://wayf.internet2.edu/InQueue/sample.jsp">
    https://wayf.internet2.edu/InQueue/sample.jsp</a>. Select your origin&#39;s name 
    and follow the login process as a user would. Note that SSL must be used, 
    and both the HS and AA must be fully configured.</p>
    <p>The test target will then display a simple page which includes the basic 
    information sent to it by your origin and the authentication rules it is 
    using.</p>
    <p><b>For information regarding specific error messages that may be 
    generated if the origin does not work successfully, please refer to section
    <a href="#6.c.">6.c</a>.</b></p>
</blockquote>
<h4><a name="6.b."></a>6.b. Logging</h4>
<blockquote>
    <p>Shibboleth&#39;s origin components log various operations which may prove 
    useful for auditing, testing, and security purposes. This data is sent 
    through <span class="fixedwidth">log4j</span>&#39;s standard mechanism. The 
    location of the log file, the level at which the log is output, the 
    formatting of the logs, and many more options may be configured by editing
    <span class="fixedwidth">/WEB-INF/classes/conf/log4j.properties</span>. By 
    default, it is setup to log to the console of the servlet container, with a 
    level of <span class="fixedwidth">WARN</span>, but there is also a commented 
    out example in the file to give a possible alternate configuration.</p>
</blockquote>
<h4><a name="6.c."></a>6.c. Common Problems</h4>
<blockquote>
    <p>A knowledge base is being developed in the
    <a href="http://www.columbia.edu/~wassa/shib.faq/shibboleth-faq.html">
    Shibboleth Deployer&#39;s FAQ</a>. Please mail
    <a href="mailto:mace-shib-users@internet2.edu">mace-shib-users@ 
    internet2.edu</a> with any additional questions or problems encountered that 
    are not answered by this basic guide.</p>
</blockquote>

</body>

</html>
